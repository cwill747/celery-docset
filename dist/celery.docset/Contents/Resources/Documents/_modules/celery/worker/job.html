<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>celery.worker.job â€” Celery 3.1.23 documentation</title>
<link href="../../../_static/celery.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '3.1.23',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
<script src="../../../_static/jquery.js" type="text/javascript"></script>
<script src="../../../_static/underscore.js" type="text/javascript"></script>
<script src="../../../_static/doctools.js" type="text/javascript"></script>
<link href="../../../copyright.html" rel="copyright" title="Copyright"/>
<link href="../../../index.html" rel="top" title="Celery 3.1.23 documentation"/>
<link href="../worker.html" rel="up" title="celery.worker"/>
</head>
<body role="document">

<div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<div class="deck">
<p>
        This document describes the current stable version of Celery (3.1). For development docs,
        <a href="http://docs.celeryproject.org/en/master/_modules/celery/worker/job.html">go here</a>.
        </p>
</div>
<h1>Source code for celery.worker.job</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">"""</span>
<span class="sd">    celery.worker.job</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~</span>

<span class="sd">    This module defines the :class:`Request` class,</span>
<span class="sd">    which specifies how tasks are executed.</span>

<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">billiard.einfo</span> <span class="kn">import</span> <span class="n">ExceptionInfo</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">weakref</span> <span class="kn">import</span> <span class="n">ref</span>

<span class="kn">from</span> <span class="nn">kombu.utils</span> <span class="kn">import</span> <span class="n">kwdict</span><span class="p">,</span> <span class="n">reprcall</span>
<span class="kn">from</span> <span class="nn">kombu.utils.encoding</span> <span class="kn">import</span> <span class="n">safe_repr</span><span class="p">,</span> <span class="n">safe_str</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">celery.app.trace</span> <span class="kn">import</span> <span class="n">trace_task</span><span class="p">,</span> <span class="n">trace_task_ret</span>
<span class="kn">from</span> <span class="nn">celery.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Ignore</span><span class="p">,</span> <span class="n">TaskRevokedError</span><span class="p">,</span> <span class="n">InvalidTaskError</span><span class="p">,</span>
    <span class="n">SoftTimeLimitExceeded</span><span class="p">,</span> <span class="n">TimeLimitExceeded</span><span class="p">,</span>
    <span class="n">WorkerLostError</span><span class="p">,</span> <span class="n">Terminated</span><span class="p">,</span> <span class="n">Retry</span><span class="p">,</span> <span class="n">Reject</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">celery.five</span> <span class="kn">import</span> <span class="n">items</span><span class="p">,</span> <span class="n">monotonic</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">string_t</span>
<span class="kn">from</span> <span class="nn">celery.platforms</span> <span class="kn">import</span> <span class="n">signals</span> <span class="k">as</span> <span class="n">_signals</span>
<span class="kn">from</span> <span class="nn">celery.utils</span> <span class="kn">import</span> <span class="n">fun_takes_kwargs</span>
<span class="kn">from</span> <span class="nn">celery.utils.functional</span> <span class="kn">import</span> <span class="n">noop</span>
<span class="kn">from</span> <span class="nn">celery.utils.log</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">celery.utils.serialization</span> <span class="kn">import</span> <span class="n">get_pickled_exception</span>
<span class="kn">from</span> <span class="nn">celery.utils.text</span> <span class="kn">import</span> <span class="n">truncate</span>
<span class="kn">from</span> <span class="nn">celery.utils.timeutils</span> <span class="kn">import</span> <span class="n">maybe_iso8601</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">maybe_make_aware</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">state</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Request'</span><span class="p">]</span>

<span class="n">IS_PYPY</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">'pypy_version_info'</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">debug</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">warn</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">,</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
<span class="n">_does_info</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">_does_debug</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">#: Max length of result representation</span>
<span class="n">RESULT_MAXLEN</span> <span class="o">=</span> <span class="mi">128</span>


<span class="k">def</span> <span class="nf">__optimize__</span><span class="p">():</span>
    <span class="c1"># this is also called by celery.app.trace.setup_worker_optimizations</span>
    <span class="k">global</span> <span class="n">_does_debug</span>
    <span class="k">global</span> <span class="n">_does_info</span>
    <span class="n">_does_debug</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">_does_info</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">__optimize__</span><span class="p">()</span>

<span class="c1"># Localize</span>
<span class="n">tz_utc</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
<span class="n">tz_or_local</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">tz_or_local</span>
<span class="n">send_revoked</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">task_revoked</span><span class="o">.</span><span class="n">send</span>

<span class="n">task_accepted</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">task_accepted</span>
<span class="n">task_ready</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">task_ready</span>
<span class="n">revoked_tasks</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">revoked</span>

<span class="n">NEEDS_KWDICT</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

<span class="c1">#: Use when no message object passed to :class:`Request`.</span>
<span class="n">DEFAULT_FIELDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'headers'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s1">'reply_to'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s1">'correlation_id'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s1">'delivery_info'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'exchange'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s1">'routing_key'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s1">'priority'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">'redelivered'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>


<div class="viewcode-block" id="Request"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request">[docs]</a><span class="k">class</span> <span class="nc">Request</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""A request for task execution."""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">IS_PYPY</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">'app'</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">,</span> <span class="s1">'id'</span><span class="p">,</span> <span class="s1">'args'</span><span class="p">,</span> <span class="s1">'kwargs'</span><span class="p">,</span> <span class="s1">'on_ack'</span><span class="p">,</span>
            <span class="s1">'hostname'</span><span class="p">,</span> <span class="s1">'eventer'</span><span class="p">,</span> <span class="s1">'connection_errors'</span><span class="p">,</span> <span class="s1">'task'</span><span class="p">,</span> <span class="s1">'eta'</span><span class="p">,</span>
            <span class="s1">'expires'</span><span class="p">,</span> <span class="s1">'request_dict'</span><span class="p">,</span> <span class="s1">'acknowledged'</span><span class="p">,</span> <span class="s1">'on_reject'</span><span class="p">,</span>
            <span class="s1">'utc'</span><span class="p">,</span> <span class="s1">'time_start'</span><span class="p">,</span> <span class="s1">'worker_pid'</span><span class="p">,</span> <span class="s1">'_already_revoked'</span><span class="p">,</span>
            <span class="s1">'_terminate_on_ack'</span><span class="p">,</span> <span class="s1">'_apply_result'</span><span class="p">,</span>
            <span class="s1">'_tzlocal'</span><span class="p">,</span> <span class="s1">'__weakref__'</span><span class="p">,</span> <span class="s1">'__dict__'</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1">#: Format string used to log task success.</span>
    <span class="n">success_msg</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">        Task </span><span class="si">%(name)s</span><span class="s2">[</span><span class="si">%(id)s</span><span class="s2">] succeeded in </span><span class="si">%(runtime)s</span><span class="s2">s: </span><span class="si">%(return_value)s</span><span class="s2"></span>
<span class="s2">    """</span>

    <span class="c1">#: Format string used to log task failure.</span>
    <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">        Task </span><span class="si">%(name)s</span><span class="s2">[</span><span class="si">%(id)s</span><span class="s2">] </span><span class="si">%(description)s</span><span class="s2">: </span><span class="si">%(exc)s</span><span class="s2"></span>
<span class="s2">    """</span>

    <span class="c1">#: Format string used to log internal error.</span>
    <span class="n">internal_error_msg</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">        Task </span><span class="si">%(name)s</span><span class="s2">[</span><span class="si">%(id)s</span><span class="s2">] </span><span class="si">%(description)s</span><span class="s2">: </span><span class="si">%(exc)s</span><span class="s2"></span>
<span class="s2">    """</span>

    <span class="n">ignored_msg</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">        Task </span><span class="si">%(name)s</span><span class="s2">[</span><span class="si">%(id)s</span><span class="s2">] </span><span class="si">%(description)s</span><span class="s2"></span>
<span class="s2">    """</span>

    <span class="n">rejected_msg</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">        Task </span><span class="si">%(name)s</span><span class="s2">[</span><span class="si">%(id)s</span><span class="s2">] </span><span class="si">%(exc)s</span><span class="s2"></span>
<span class="s2">    """</span>

    <span class="c1">#: Format string used to log task retry.</span>
    <span class="n">retry_msg</span> <span class="o">=</span> <span class="s2">"""Task </span><span class="si">%(name)s</span><span class="s2">[</span><span class="si">%(id)s</span><span class="s2">] retry: </span><span class="si">%(exc)s</span><span class="s2">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">on_ack</span><span class="o">=</span><span class="n">noop</span><span class="p">,</span>
                 <span class="n">hostname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">eventer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">connection_errors</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">request_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">on_reject</span><span class="o">=</span><span class="n">noop</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s1">'task'</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'args'</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'kwargs'</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidTaskError</span><span class="p">(</span>
                <span class="s1">'Task keyword arguments is not a mapping'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">NEEDS_KWDICT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwdict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'eta'</span><span class="p">)</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'expires'</span><span class="p">)</span>
        <span class="n">utc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'utc'</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_ack</span> <span class="o">=</span> <span class="n">on_ack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_reject</span> <span class="o">=</span> <span class="n">on_reject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname</span> <span class="ow">or</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventer</span> <span class="o">=</span> <span class="n">eventer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_errors</span> <span class="o">=</span> <span class="n">connection_errors</span> <span class="ow">or</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acknowledged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_already_revoked</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_on_ack</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tzlocal</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># timezone means the message is timezone-aware, and the only timezone</span>
        <span class="c1"># supported at this point is UTC.</span>
        <span class="k">if</span> <span class="n">eta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="n">maybe_iso8601</span><span class="p">(</span><span class="n">eta</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidTaskError</span><span class="p">(</span>
                    <span class="s1">'invalid eta value {0!r}: {1}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">utc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="n">maybe_make_aware</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tzlocal</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">expires</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">maybe_iso8601</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidTaskError</span><span class="p">(</span>
                    <span class="s1">'invalid expires value {0!r}: {1}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expires</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">utc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">maybe_make_aware</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tzlocal</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
            <span class="n">delivery_info</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">delivery_info</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">properties</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">body</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">'headers'</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                <span class="s1">'reply_to'</span><span class="p">:</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'reply_to'</span><span class="p">),</span>
                <span class="s1">'correlation_id'</span><span class="p">:</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'correlation_id'</span><span class="p">),</span>
                <span class="s1">'delivery_info'</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">'exchange'</span><span class="p">:</span> <span class="n">delivery_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'exchange'</span><span class="p">),</span>
                    <span class="s1">'routing_key'</span><span class="p">:</span> <span class="n">delivery_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'routing_key'</span><span class="p">),</span>
                    <span class="s1">'priority'</span><span class="p">:</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">'priority'</span><span class="p">,</span> <span class="n">delivery_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'priority'</span><span class="p">)),</span>
                    <span class="s1">'redelivered'</span><span class="p">:</span> <span class="n">delivery_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'redelivered'</span><span class="p">),</span>
                <span class="p">}</span>

            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">DEFAULT_FIELDS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_dict</span> <span class="o">=</span> <span class="n">body</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delivery_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_dict</span><span class="p">[</span><span class="s1">'delivery_info'</span><span class="p">]</span>

<div class="viewcode-block" id="Request.extend_with_default_kwargs"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.extend_with_default_kwargs">[docs]</a>    <span class="k">def</span> <span class="nf">extend_with_default_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Extend the tasks keyword arguments with standard task arguments.</span>

<span class="sd">        Currently these are `logfile`, `loglevel`, `task_id`,</span>
<span class="sd">        `task_name`, `task_retries`, and `delivery_info`.</span>

<span class="sd">        See :meth:`celery.task.base.Task.run` for more information.</span>

<span class="sd">        Magic keyword arguments are deprecated and will be removed</span>
<span class="sd">        in version 4.0.</span>

<span class="sd">        """</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">default_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'logfile'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>   <span class="c1"># deprecated</span>
                          <span class="s1">'loglevel'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>  <span class="c1"># deprecated</span>
                          <span class="s1">'task_id'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                          <span class="s1">'task_name'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                          <span class="s1">'task_retries'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'retries'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                          <span class="s1">'task_is_eager'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                          <span class="s1">'delivery_info'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delivery_info</span><span class="p">}</span>
        <span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">run</span>
        <span class="n">supported_keys</span> <span class="o">=</span> <span class="n">fun_takes_kwargs</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">default_kwargs</span><span class="p">)</span>
        <span class="n">extend_with</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">items</span><span class="p">(</span><span class="n">default_kwargs</span><span class="p">)</span>
                           <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">supported_keys</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extend_with</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kwargs</span></div>

<div class="viewcode-block" id="Request.execute_using_pool"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.execute_using_pool">[docs]</a>    <span class="k">def</span> <span class="nf">execute_using_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""Used by the worker to send this task to the pool.</span>

<span class="sd">        :param pool: A :class:`celery.concurrency.base.TaskPool` instance.</span>

<span class="sd">        :raises celery.exceptions.TaskRevokedError: if the task was revoked</span>
<span class="sd">            and ignored.</span>

<span class="sd">        """</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revoked</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">TaskRevokedError</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>

        <span class="n">hostname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">accept_magic_kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extend_with_default_kwargs</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_dict</span>
        <span class="n">request</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'hostname'</span><span class="p">:</span> <span class="n">hostname</span><span class="p">,</span> <span class="s1">'is_eager'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                        <span class="s1">'delivery_info'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delivery_info</span><span class="p">,</span>
                        <span class="s1">'group'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'taskset'</span><span class="p">)})</span>
        <span class="n">timeout</span><span class="p">,</span> <span class="n">soft_timeout</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'timelimit'</span><span class="p">,</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="n">task</span><span class="o">.</span><span class="n">time_limit</span>
        <span class="n">soft_timeout</span> <span class="o">=</span> <span class="n">soft_timeout</span> <span class="ow">or</span> <span class="n">task</span><span class="o">.</span><span class="n">soft_time_limit</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span>
            <span class="n">trace_task_ret</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">request</span><span class="p">),</span>
            <span class="n">accept_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_accepted</span><span class="p">,</span>
            <span class="n">timeout_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_timeout</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_success</span><span class="p">,</span>
            <span class="n">error_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_failure</span><span class="p">,</span>
            <span class="n">soft_timeout</span><span class="o">=</span><span class="n">soft_timeout</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">correlation_id</span><span class="o">=</span><span class="n">uuid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># cannot create weakref to None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_result</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Request.execute"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">"""Execute the task in a :func:`~celery.app.trace.trace_task`.</span>

<span class="sd">        :keyword loglevel: The loglevel used by the task.</span>
<span class="sd">        :keyword logfile: The logfile used by the task.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revoked</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="c1"># acknowledge task as being processed.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">acks_late</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acknowledge</span><span class="p">()</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">accept_magic_kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extend_with_default_kwargs</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_dict</span>
        <span class="n">request</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'loglevel'</span><span class="p">:</span> <span class="n">loglevel</span><span class="p">,</span> <span class="s1">'logfile'</span><span class="p">:</span> <span class="n">logfile</span><span class="p">,</span>
                        <span class="s1">'hostname'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="s1">'is_eager'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                        <span class="s1">'delivery_info'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delivery_info</span><span class="p">})</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">trace_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>
                            <span class="n">hostname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">loader</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loader</span><span class="p">,</span>
                            <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acknowledge</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">retval</span></div>

<div class="viewcode-block" id="Request.maybe_expire"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.maybe_expire">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_expire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""If expired, mark the task as revoked."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="p">:</span>
                <span class="n">revoked_tasks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="Request.terminate"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.terminate">[docs]</a>    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">_signals</span><span class="o">.</span><span class="n">signum</span><span class="p">(</span><span class="n">signal</span> <span class="ow">or</span> <span class="s1">'TERM'</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_start</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">terminate_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_pid</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_announce_revoked</span><span class="p">(</span><span class="s1">'terminated'</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_on_ack</span> <span class="o">=</span> <span class="n">pool</span><span class="p">,</span> <span class="n">signal</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_result</span><span class="p">()</span>  <span class="c1"># is a weakref</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">terminate</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_announce_revoked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">expired</span><span class="p">):</span>
        <span class="n">task_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_event</span><span class="p">(</span><span class="s1">'task-revoked'</span><span class="p">,</span>
                        <span class="n">terminated</span><span class="o">=</span><span class="n">terminated</span><span class="p">,</span> <span class="n">signum</span><span class="o">=</span><span class="n">signum</span><span class="p">,</span> <span class="n">expired</span><span class="o">=</span><span class="n">expired</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">mark_as_revoked</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acknowledge</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_already_revoked</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">send_revoked</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">terminated</span><span class="o">=</span><span class="n">terminated</span><span class="p">,</span> <span class="n">signum</span><span class="o">=</span><span class="n">signum</span><span class="p">,</span> <span class="n">expired</span><span class="o">=</span><span class="n">expired</span><span class="p">)</span>

<div class="viewcode-block" id="Request.revoked"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.revoked">[docs]</a>    <span class="k">def</span> <span class="nf">revoked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""If revoked, skip task and mark state."""</span>
        <span class="n">expired</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_already_revoked</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="p">:</span>
            <span class="n">expired</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_expire</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">revoked_tasks</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">'Discarding revoked task: </span><span class="si">%s</span><span class="s1">[</span><span class="si">%s</span><span class="s1">]'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_announce_revoked</span><span class="p">(</span>
                <span class="s1">'expired'</span> <span class="k">if</span> <span class="n">expired</span> <span class="k">else</span> <span class="s1">'revoked'</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">expired</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="Request.send_event"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.send_event">[docs]</a>    <span class="k">def</span> <span class="nf">send_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="o">**</span><span class="n">fields</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventer</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eventer</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="o">**</span><span class="n">fields</span><span class="p">)</span></div>

<div class="viewcode-block" id="Request.on_accepted"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.on_accepted">[docs]</a>    <span class="k">def</span> <span class="nf">on_accepted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">time_accepted</span><span class="p">):</span>
        <span class="sd">"""Handler called when task is accepted by worker pool."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_pid</span> <span class="o">=</span> <span class="n">pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_start</span> <span class="o">=</span> <span class="n">time_accepted</span>
        <span class="n">task_accepted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">acks_late</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acknowledge</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_event</span><span class="p">(</span><span class="s1">'task-started'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_does_debug</span><span class="p">:</span>
            <span class="n">debug</span><span class="p">(</span><span class="s1">'Task accepted: </span><span class="si">%s</span><span class="s1">[</span><span class="si">%s</span><span class="s1">] pid:</span><span class="si">%r</span><span class="s1">'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_on_ack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminate</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_terminate_on_ack</span><span class="p">)</span></div>

<div class="viewcode-block" id="Request.on_timeout"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.on_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">on_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soft</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="sd">"""Handler called if the task times out."""</span>
        <span class="n">task_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">soft</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">'Soft time limit (</span><span class="si">%s</span><span class="s1">s) exceeded for </span><span class="si">%s</span><span class="s1">[</span><span class="si">%s</span><span class="s1">]'</span><span class="p">,</span>
                 <span class="n">timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">SoftTimeLimitExceeded</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">'Hard time limit (</span><span class="si">%s</span><span class="s1">s) exceeded for </span><span class="si">%s</span><span class="s1">[</span><span class="si">%s</span><span class="s1">]'</span><span class="p">,</span>
                  <span class="n">timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">TimeLimitExceeded</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">mark_as_failure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">acks_late</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acknowledge</span><span class="p">()</span></div>

<div class="viewcode-block" id="Request.on_success"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.on_success">[docs]</a>    <span class="k">def</span> <span class="nf">on_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret_value</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nowfun</span><span class="o">=</span><span class="n">monotonic</span><span class="p">):</span>
        <span class="sd">"""Handler called if the task was successfully processed."""</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret_value</span><span class="p">,</span> <span class="n">ExceptionInfo</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret_value</span><span class="o">.</span><span class="n">exception</span><span class="p">,</span> <span class="p">(</span>
                    <span class="ne">SystemExit</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">ret_value</span><span class="o">.</span><span class="n">exception</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_failure</span><span class="p">(</span><span class="n">ret_value</span><span class="p">)</span>
        <span class="n">task_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">acks_late</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acknowledge</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventer</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">nowfun</span><span class="p">()</span>
            <span class="n">runtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_start</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_start</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_event</span><span class="p">(</span><span class="s1">'task-succeeded'</span><span class="p">,</span>
                            <span class="n">result</span><span class="o">=</span><span class="n">safe_repr</span><span class="p">(</span><span class="n">ret_value</span><span class="p">),</span> <span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_does_info</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">now</span> <span class="ow">or</span> <span class="n">nowfun</span><span class="p">()</span>
            <span class="n">runtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_start</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_start</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">success_msg</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="p">{</span>
                <span class="s1">'id'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">'return_value'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">repr_result</span><span class="p">(</span><span class="n">ret_value</span><span class="p">),</span>
                <span class="s1">'runtime'</span><span class="p">:</span> <span class="n">runtime</span><span class="p">})</span></div>

<div class="viewcode-block" id="Request.on_retry"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.on_retry">[docs]</a>    <span class="k">def</span> <span class="nf">on_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">):</span>
        <span class="sd">"""Handler called if the task should be retried."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">acks_late</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acknowledge</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send_event</span><span class="p">(</span><span class="s1">'task-retried'</span><span class="p">,</span>
                        <span class="n">exception</span><span class="o">=</span><span class="n">safe_repr</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">exc</span><span class="p">),</span>
                        <span class="n">traceback</span><span class="o">=</span><span class="n">safe_str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">traceback</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">_does_info</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_msg</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                 <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                  <span class="s1">'exc'</span><span class="p">:</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">exception</span><span class="p">})</span></div>

<div class="viewcode-block" id="Request.on_failure"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.on_failure">[docs]</a>    <span class="k">def</span> <span class="nf">on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">):</span>
        <span class="sd">"""Handler called if the task raised an exception."""</span>
        <span class="n">task_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">send_failed_event</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">internal</span><span class="p">:</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">exception</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">Retry</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_retry</span><span class="p">(</span><span class="n">exc_info</span><span class="p">)</span>

            <span class="c1"># These are special cases where the process would not have had</span>
            <span class="c1"># time to write the result.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_errors</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">WorkerLostError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">mark_as_failure</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">Terminated</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_announce_revoked</span><span class="p">(</span>
                        <span class="s1">'terminated'</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">string</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>
                    <span class="n">send_failed_event</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c1"># already sent revoked event</span>
            <span class="c1"># (acks_late) acknowledge after result stored.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">acks_late</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acknowledge</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="n">exc_info</span><span class="p">,</span> <span class="n">send_failed_event</span><span class="o">=</span><span class="n">send_failed_event</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">einfo</span><span class="p">,</span> <span class="n">send_failed_event</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">einfo</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">get_pickled_exception</span><span class="p">(</span><span class="n">einfo</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>
        <span class="n">eobj</span> <span class="o">=</span> <span class="n">einfo</span><span class="o">.</span><span class="n">exception</span>
        <span class="n">exception</span><span class="p">,</span> <span class="n">traceback</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">,</span> <span class="n">internal</span><span class="p">,</span> <span class="n">sargs</span><span class="p">,</span> <span class="n">skwargs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">safe_repr</span><span class="p">(</span><span class="n">eobj</span><span class="p">),</span>
            <span class="n">safe_str</span><span class="p">(</span><span class="n">einfo</span><span class="o">.</span><span class="n">traceback</span><span class="p">),</span>
            <span class="n">einfo</span><span class="o">.</span><span class="n">exc_info</span><span class="p">,</span>
            <span class="n">einfo</span><span class="o">.</span><span class="n">internal</span><span class="p">,</span>
            <span class="n">safe_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">),</span>
            <span class="n">safe_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">throws</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eobj</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">throws</span><span class="p">):</span>
            <span class="n">do_send_mail</span><span class="p">,</span> <span class="n">severity</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">False</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">'raised expected'</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_send_mail</span><span class="p">,</span> <span class="n">severity</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">True</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="s1">'raised unexpected'</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span>
        <span class="k">if</span> <span class="n">internal</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">einfo</span><span class="o">.</span><span class="n">exception</span><span class="p">,</span> <span class="ne">MemoryError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">(</span><span class="s1">'Process got: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">einfo</span><span class="o">.</span><span class="n">exception</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">einfo</span><span class="o">.</span><span class="n">exception</span><span class="p">,</span> <span class="n">Reject</span><span class="p">):</span>
                <span class="n">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rejected_msg</span>
                <span class="n">description</span> <span class="o">=</span> <span class="s1">'rejected'</span>
                <span class="n">severity</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARN</span>
                <span class="n">send_failed_event</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">requeue</span><span class="o">=</span><span class="n">einfo</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">requeue</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">einfo</span><span class="o">.</span><span class="n">exception</span><span class="p">,</span> <span class="n">Ignore</span><span class="p">):</span>
                <span class="n">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignored_msg</span>
                <span class="n">description</span> <span class="o">=</span> <span class="s1">'ignored'</span>
                <span class="n">severity</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
                <span class="n">exc_info</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">send_failed_event</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acknowledge</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_error_msg</span>
                <span class="n">description</span> <span class="o">=</span> <span class="s1">'INTERNAL ERROR'</span>
                <span class="n">severity</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span>

        <span class="k">if</span> <span class="n">send_failed_event</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_event</span><span class="p">(</span>
                <span class="s1">'task-failed'</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">exception</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="n">traceback</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'hostname'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
            <span class="s1">'id'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">'name'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">'exc'</span><span class="p">:</span> <span class="n">exception</span><span class="p">,</span>
            <span class="s1">'traceback'</span><span class="p">:</span> <span class="n">traceback</span><span class="p">,</span>
            <span class="s1">'args'</span><span class="p">:</span> <span class="n">sargs</span><span class="p">,</span>
            <span class="s1">'kwargs'</span><span class="p">:</span> <span class="n">skwargs</span><span class="p">,</span>
            <span class="s1">'description'</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">severity</span><span class="p">,</span> <span class="n">format</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">context</span><span class="p">,</span>
                   <span class="n">exc_info</span><span class="o">=</span><span class="n">exc_info</span><span class="p">,</span>
                   <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">'data'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                   <span class="s1">'name'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                   <span class="s1">'args'</span><span class="p">:</span> <span class="n">sargs</span><span class="p">,</span>
                                   <span class="s1">'kwargs'</span><span class="p">:</span> <span class="n">skwargs</span><span class="p">,</span>
                                   <span class="s1">'hostname'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
                                   <span class="s1">'internal'</span><span class="p">:</span> <span class="n">internal</span><span class="p">}})</span>

        <span class="k">if</span> <span class="n">do_send_mail</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">send_error_email</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">einfo</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>

<div class="viewcode-block" id="Request.acknowledge"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.acknowledge">[docs]</a>    <span class="k">def</span> <span class="nf">acknowledge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Acknowledge task."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">acknowledged</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_ack</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_errors</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acknowledged</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="Request.reject"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.reject">[docs]</a>    <span class="k">def</span> <span class="nf">reject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requeue</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">acknowledged</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_reject</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_errors</span><span class="p">,</span> <span class="n">requeue</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acknowledged</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="Request.repr_result"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.repr_result">[docs]</a>    <span class="k">def</span> <span class="nf">repr_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="n">RESULT_MAXLEN</span><span class="p">):</span>
        <span class="c1"># 46 is the length needed to fit</span>
        <span class="c1">#     'the quick brown fox jumps over the lazy dog' :)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">string_t</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">truncate</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxlen</span> <span class="k">else</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Request.info"><a class="viewcode-back" href="../../../reference/celery.worker.job.html#celery.worker.job.Request.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'name'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">'args'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="k">if</span> <span class="n">safe</span> <span class="k">else</span> <span class="n">safe_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">),</span>
                <span class="s1">'kwargs'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="k">if</span> <span class="n">safe</span> <span class="k">else</span> <span class="n">safe_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">),</span>
                <span class="s1">'hostname'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
                <span class="s1">'time_start'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_start</span><span class="p">,</span>
                <span class="s1">'acknowledged'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">acknowledged</span><span class="p">,</span>
                <span class="s1">'delivery_info'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delivery_info</span><span class="p">,</span>
                <span class="s1">'worker_pid'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_pid</span><span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">'{0.name}[{0.id}]{1}{2}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="s1">' eta:[{0}]'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="k">else</span> <span class="s1">''</span><span class="p">,</span>
            <span class="s1">' expires:[{0}]'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="k">else</span> <span class="s1">''</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">shortinfo</span> <span class="o">=</span> <span class="n">__str__</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">'&lt;{0} {1}: {2}&gt;'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">reprcall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tzlocal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tzlocal</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tzlocal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">CELERY_TIMEZONE</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tzlocal</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">store_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">ignore_result</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">store_errors_even_if_ignored</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">task_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># XXX compat</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

    <span class="nd">@task_id.setter</span>  <span class="c1"># noqa</span>
    <span class="k">def</span> <span class="nf">task_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">task_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># XXX compat</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@task_name.setter</span>  <span class="c1"># noqa</span>
    <span class="k">def</span> <span class="nf">task_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reply_to</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># used by rpc backend when failures reported by parent process</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_dict</span><span class="p">[</span><span class="s1">'reply_to'</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">correlation_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># used similarly to reply_to</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_dict</span><span class="p">[</span><span class="s1">'correlation_id'</span><span class="p">]</span></div>
</pre></div>
</div>
</div>
</div>

<div class="clearer"></div>
</div>

<div class="footer" role="contentinfo">
        Â© <a href="../../../copyright.html">Copyright</a> 2009-2015, Ask Solem &amp; Contributors.
    </div>
</body>
</html>