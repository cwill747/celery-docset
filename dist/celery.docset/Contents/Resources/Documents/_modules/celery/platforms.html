<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>celery.platforms â€” Celery 3.1.23 documentation</title>
<link href="../../_static/celery.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.1.23',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
<script src="../../_static/jquery.js" type="text/javascript"></script>
<script src="../../_static/underscore.js" type="text/javascript"></script>
<script src="../../_static/doctools.js" type="text/javascript"></script>
<link href="../../copyright.html" rel="copyright" title="Copyright"/>
<link href="../../index.html" rel="top" title="Celery 3.1.23 documentation"/>
<link href="../index.html" rel="up" title="Module code"/>
</head>
<body role="document">

<div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<div class="deck">
<p>
        This document describes the current stable version of Celery (3.1). For development docs,
        <a href="http://docs.celeryproject.org/en/master/_modules/celery/platforms.html">go here</a>.
        </p>
</div>
<h1>Source code for celery.platforms</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">"""</span>
<span class="sd">    celery.platforms</span>
<span class="sd">    ~~~~~~~~~~~~~~~~</span>

<span class="sd">    Utilities dealing with platform specifics: signals, daemonization,</span>
<span class="sd">    users, groups, and so on.</span>

<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span> <span class="kn">as</span> <span class="nn">_platform</span>
<span class="kn">import</span> <span class="nn">signal</span> <span class="kn">as</span> <span class="nn">_signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="kn">from</span> <span class="nn">billiard</span> <span class="kn">import</span> <span class="n">current_process</span>
<span class="c1"># fileno used to be in this module</span>
<span class="kn">from</span> <span class="nn">kombu.utils</span> <span class="kn">import</span> <span class="n">maybe_fileno</span>
<span class="kn">from</span> <span class="nn">kombu.utils.compat</span> <span class="kn">import</span> <span class="n">get_errno</span>
<span class="kn">from</span> <span class="nn">kombu.utils.encoding</span> <span class="kn">import</span> <span class="n">safe_str</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="kn">from</span> <span class="nn">.local</span> <span class="kn">import</span> <span class="n">try_import</span>
<span class="kn">from</span> <span class="nn">.five</span> <span class="kn">import</span> <span class="n">items</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="n">reraise</span><span class="p">,</span> <span class="n">string_t</span><span class="p">,</span> <span class="n">zip_longest</span>
<span class="kn">from</span> <span class="nn">.utils.functional</span> <span class="kn">import</span> <span class="n">uniq</span>

<span class="n">_setproctitle</span> <span class="o">=</span> <span class="n">try_import</span><span class="p">(</span><span class="s1">'setproctitle'</span><span class="p">)</span>
<span class="n">resource</span> <span class="o">=</span> <span class="n">try_import</span><span class="p">(</span><span class="s1">'resource'</span><span class="p">)</span>
<span class="n">pwd</span> <span class="o">=</span> <span class="n">try_import</span><span class="p">(</span><span class="s1">'pwd'</span><span class="p">)</span>
<span class="n">grp</span> <span class="o">=</span> <span class="n">try_import</span><span class="p">(</span><span class="s1">'grp'</span><span class="p">)</span>
<span class="n">mputil</span> <span class="o">=</span> <span class="n">try_import</span><span class="p">(</span><span class="s1">'multiprocessing.util'</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'EX_OK'</span><span class="p">,</span> <span class="s1">'EX_FAILURE'</span><span class="p">,</span> <span class="s1">'EX_UNAVAILABLE'</span><span class="p">,</span> <span class="s1">'EX_USAGE'</span><span class="p">,</span> <span class="s1">'SYSTEM'</span><span class="p">,</span>
           <span class="s1">'IS_OSX'</span><span class="p">,</span> <span class="s1">'IS_WINDOWS'</span><span class="p">,</span> <span class="s1">'pyimplementation'</span><span class="p">,</span> <span class="s1">'LockFailed'</span><span class="p">,</span>
           <span class="s1">'get_fdmax'</span><span class="p">,</span> <span class="s1">'Pidfile'</span><span class="p">,</span> <span class="s1">'create_pidlock'</span><span class="p">,</span>
           <span class="s1">'close_open_fds'</span><span class="p">,</span> <span class="s1">'DaemonContext'</span><span class="p">,</span> <span class="s1">'detached'</span><span class="p">,</span> <span class="s1">'parse_uid'</span><span class="p">,</span>
           <span class="s1">'parse_gid'</span><span class="p">,</span> <span class="s1">'setgroups'</span><span class="p">,</span> <span class="s1">'initgroups'</span><span class="p">,</span> <span class="s1">'setgid'</span><span class="p">,</span> <span class="s1">'setuid'</span><span class="p">,</span>
           <span class="s1">'maybe_drop_privileges'</span><span class="p">,</span> <span class="s1">'signals'</span><span class="p">,</span> <span class="s1">'set_process_title'</span><span class="p">,</span>
           <span class="s1">'set_mp_process_title'</span><span class="p">,</span> <span class="s1">'get_errno_name'</span><span class="p">,</span> <span class="s1">'ignore_errno'</span><span class="p">,</span>
           <span class="s1">'fd_by_path'</span><span class="p">]</span>

<span class="c1"># exitcodes</span>
<span class="n">EX_OK</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">'EX_OK'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">EX_FAILURE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">EX_UNAVAILABLE</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">'EX_UNAVAILABLE'</span><span class="p">,</span> <span class="mi">69</span><span class="p">)</span>
<span class="n">EX_USAGE</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">'EX_USAGE'</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<span class="n">EX_CANTCREAT</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">'EX_CANTCREAT'</span><span class="p">,</span> <span class="mi">73</span><span class="p">)</span>

<span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">_platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
<span class="n">IS_OSX</span> <span class="o">=</span> <span class="n">SYSTEM</span> <span class="o">==</span> <span class="s1">'Darwin'</span>
<span class="n">IS_WINDOWS</span> <span class="o">=</span> <span class="n">SYSTEM</span> <span class="o">==</span> <span class="s1">'Windows'</span>

<span class="n">DAEMON_WORKDIR</span> <span class="o">=</span> <span class="s1">'/'</span>

<span class="n">PIDFILE_FLAGS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_EXCL</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span>
<span class="n">PIDFILE_MODE</span> <span class="o">=</span> <span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">R_OK</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">))</span>

<span class="n">PIDLOCKED</span> <span class="o">=</span> <span class="s2">"""ERROR: Pidfile ({0}) already exists.</span>
<span class="s2">Seems we're already running? (pid: {1})"""</span>

<span class="n">_range</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">'_range'</span><span class="p">,</span> <span class="p">(</span><span class="s1">'start'</span><span class="p">,</span> <span class="s1">'stop'</span><span class="p">))</span>

<span class="n">C_FORCE_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'C_FORCE_ROOT'</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

<span class="n">ROOT_DISALLOWED</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">Running a worker with superuser privileges when the</span>
<span class="s2">worker accepts messages serialized with pickle is a very bad idea!</span>

<span class="s2">If you really want to continue then you have to set the C_FORCE_ROOT</span>
<span class="s2">environment variable (but please think about this before you do).</span>

<span class="s2">User information: uid={uid} euid={euid} gid={gid} egid={egid}</span>
<span class="s2">"""</span>

<span class="n">ROOT_DISCOURAGED</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">You are running the worker with superuser privileges, which is</span>
<span class="s2">absolutely not recommended!</span>

<span class="s2">Please specify a different user using the -u option.</span>

<span class="s2">User information: uid={uid} euid={euid} gid={gid} egid={egid}</span>
<span class="s2">"""</span>


<div class="viewcode-block" id="pyimplementation"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.pyimplementation">[docs]</a><span class="k">def</span> <span class="nf">pyimplementation</span><span class="p">():</span>
    <span class="sd">"""Return string identifying the current Python implementation."""</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_platform</span><span class="p">,</span> <span class="s1">'python_implementation'</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_platform</span><span class="o">.</span><span class="n">python_implementation</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'java'</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">'Jython '</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">'pypy_version_info'</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">pypy_version_info</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">pypy_version_info</span><span class="p">[</span><span class="mi">3</span><span class="p">:]:</span>
            <span class="n">v</span> <span class="o">+=</span> <span class="s1">'-'</span> <span class="o">+</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">pypy_version_info</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
        <span class="k">return</span> <span class="s1">'PyPy '</span> <span class="o">+</span> <span class="n">v</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'CPython'</span></div>


<div class="viewcode-block" id="LockFailed"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.LockFailed">[docs]</a><span class="k">class</span> <span class="nc">LockFailed</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">"""Raised if a pidlock can't be acquired."""</span></div>


<div class="viewcode-block" id="get_fdmax"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.get_fdmax">[docs]</a><span class="k">def</span> <span class="nf">get_fdmax</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">"""Return the maximum number of open file descriptors</span>
<span class="sd">    on this system.</span>

<span class="sd">    :keyword default: Value returned if there's no file</span>
<span class="sd">                      descriptor limit.</span>

<span class="sd">    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf</span><span class="p">(</span><span class="s1">'SC_OPEN_MAX'</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="n">resource</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1"># Windows</span>
        <span class="k">return</span> <span class="n">default</span>
    <span class="n">fdmax</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_NOFILE</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fdmax</span> <span class="o">==</span> <span class="n">resource</span><span class="o">.</span><span class="n">RLIM_INFINITY</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>
    <span class="k">return</span> <span class="n">fdmax</span></div>


<div class="viewcode-block" id="Pidfile"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.Pidfile">[docs]</a><span class="k">class</span> <span class="nc">Pidfile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""Pidfile</span>

<span class="sd">    This is the type returned by :func:`create_pidlock`.</span>

<span class="sd">    TIP: Use the :func:`create_pidlock` function instead,</span>
<span class="sd">    which is more convenient and also removes stale pidfiles (when</span>
<span class="sd">    the process holding the lock is no longer running).</span>

<span class="sd">    """</span>

    <span class="c1">#: Path to the pid lock file.</span>
    <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<div class="viewcode-block" id="Pidfile.acquire"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.Pidfile.acquire">[docs]</a>    <span class="k">def</span> <span class="nf">acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Acquire lock."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_pid</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">reraise</span><span class="p">(</span><span class="n">LockFailed</span><span class="p">,</span> <span class="n">LockFailed</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)),</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    <span class="n">__enter__</span> <span class="o">=</span> <span class="n">acquire</span>

<div class="viewcode-block" id="Pidfile.is_locked"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.Pidfile.is_locked">[docs]</a>    <span class="k">def</span> <span class="nf">is_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return true if the pid lock exists."""</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pidfile.release"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.Pidfile.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">"""Release lock."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span></div>
    <span class="n">__exit__</span> <span class="o">=</span> <span class="n">release</span>

<div class="viewcode-block" id="Pidfile.read_pid"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.Pidfile.read_pid">[docs]</a>    <span class="k">def</span> <span class="nf">read_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Read and return the current pid."""</span>
        <span class="k">with</span> <span class="n">ignore_errno</span><span class="p">(</span><span class="s1">'ENOENT'</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">line</span><span class="p">:</span>  <span class="c1"># must contain '\n'</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">'Partial or invalid pidfile {0.path}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">'pidfile {0.path} contents invalid.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>

<div class="viewcode-block" id="Pidfile.remove"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.Pidfile.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Remove the lock."""</span>
        <span class="k">with</span> <span class="n">ignore_errno</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pidfile.remove_if_stale"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.Pidfile.remove_if_stale">[docs]</a>    <span class="k">def</span> <span class="nf">remove_if_stale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Remove the lock if the process is not running.</span>
<span class="sd">        (does not respond to signals)."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_pid</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'Broken pidfile found. Removing it.'</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">os</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ESRCH</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">'Stale pidfile exists. Removing it.'</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="Pidfile.write_pid"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.Pidfile.write_pid">[docs]</a>    <span class="k">def</span> <span class="nf">write_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s1">'{0}</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

        <span class="n">pidfile_fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">PIDFILE_FLAGS</span><span class="p">,</span> <span class="n">PIDFILE_MODE</span><span class="p">)</span>
        <span class="n">pidfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">pidfile_fd</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pidfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="c1"># flush and sync so that the re-read below works.</span>
            <span class="n">pidfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">fsync</span><span class="p">(</span><span class="n">pidfile_fd</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">pidfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">rfh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rfh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">!=</span> <span class="n">content</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LockFailed</span><span class="p">(</span>
                    <span class="s2">"Inconsistency: Pidfile content doesn't match at re-read"</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">rfh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
<span class="n">PIDFile</span> <span class="o">=</span> <span class="n">Pidfile</span>  <span class="c1"># compat alias</span>


<div class="viewcode-block" id="create_pidlock"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.create_pidlock">[docs]</a><span class="k">def</span> <span class="nf">create_pidlock</span><span class="p">(</span><span class="n">pidfile</span><span class="p">):</span>
    <span class="sd">"""Create and verify pidfile.</span>

<span class="sd">    If the pidfile already exists the program exits with an error message,</span>
<span class="sd">    however if the process it refers to is not running anymore, the pidfile</span>
<span class="sd">    is deleted and the program continues.</span>

<span class="sd">    This function will automatically install an :mod:`atexit` handler</span>
<span class="sd">    to release the lock at exit, you can skip this by calling</span>
<span class="sd">    :func:`_create_pidlock` instead.</span>

<span class="sd">    :returns: :class:`Pidfile`.</span>

<span class="sd">    **Example**:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        pidlock = create_pidlock('/var/run/app.pid')</span>

<span class="sd">    """</span>
    <span class="n">pidlock</span> <span class="o">=</span> <span class="n">_create_pidlock</span><span class="p">(</span><span class="n">pidfile</span><span class="p">)</span>
    <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">pidlock</span><span class="o">.</span><span class="n">release</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pidlock</span></div>


<span class="k">def</span> <span class="nf">_create_pidlock</span><span class="p">(</span><span class="n">pidfile</span><span class="p">):</span>
    <span class="n">pidlock</span> <span class="o">=</span> <span class="n">Pidfile</span><span class="p">(</span><span class="n">pidfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pidlock</span><span class="o">.</span><span class="n">is_locked</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pidlock</span><span class="o">.</span><span class="n">remove_if_stale</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="n">PIDLOCKED</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pidfile</span><span class="p">,</span> <span class="n">pidlock</span><span class="o">.</span><span class="n">read_pid</span><span class="p">()),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">EX_CANTCREAT</span><span class="p">)</span>
    <span class="n">pidlock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pidlock</span>


<div class="viewcode-block" id="fd_by_path"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.fd_by_path">[docs]</a><span class="k">def</span> <span class="nf">fd_by_path</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
    <span class="sd">"""Return a list of fds.</span>

<span class="sd">    This method returns list of fds corresponding to</span>
<span class="sd">    file paths passed in paths variable.</span>

<span class="sd">    :keyword paths: List of file paths go get fd for.</span>

<span class="sd">    :returns: :list:.</span>

<span class="sd">    **Example**:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        keep = fd_by_path(['/dev/urandom',</span>
<span class="sd">                           '/my/precious/'])</span>
<span class="sd">    """</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">fd</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fd_in_stats</span><span class="p">(</span><span class="n">fd</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">fd</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">stats</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">_fd</span> <span class="k">for</span> <span class="n">_fd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">get_fdmax</span><span class="p">(</span><span class="mi">2048</span><span class="p">))</span> <span class="k">if</span> <span class="n">fd_in_stats</span><span class="p">(</span><span class="n">_fd</span><span class="p">)]</span></div>


<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">'closerange'</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">close_open_fds</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># must make sure this is 0-inclusive (Issue #1882)</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">uniq</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">maybe_fileno</span><span class="p">,</span> <span class="n">keep</span> <span class="ow">or</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="p">)))</span>
        <span class="n">maxfd</span> <span class="o">=</span> <span class="n">get_fdmax</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">2048</span><span class="p">)</span>
        <span class="n">kL</span><span class="p">,</span> <span class="n">kH</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keep</span><span class="p">),</span> <span class="nb">iter</span><span class="p">(</span><span class="n">keep</span> <span class="o">+</span> <span class="p">[</span><span class="n">maxfd</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="n">kL</span><span class="p">,</span> <span class="n">kH</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">low</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">high</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">closerange</span><span class="p">(</span><span class="n">low</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>

<div class="viewcode-block" id="close_open_fds"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.close_open_fds">[docs]</a>    <span class="k">def</span> <span class="nf">close_open_fds</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>  <span class="c1"># noqa</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">maybe_fileno</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="n">keep</span> <span class="ow">or</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">maybe_fileno</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">get_fdmax</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">2048</span><span class="p">))):</span>
            <span class="k">if</span> <span class="n">fd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ignore_errno</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EBADF</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span></div>


<div class="viewcode-block" id="DaemonContext"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.DaemonContext">[docs]</a><span class="k">class</span> <span class="nc">DaemonContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">_is_open</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pidfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">umask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">fake</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">after_chdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">after_forkers</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">umask</span><span class="p">,</span> <span class="n">string_t</span><span class="p">):</span>
            <span class="c1"># octal or decimal, depending on initial zero.</span>
            <span class="n">umask</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">umask</span><span class="p">,</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">umask</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'0'</span><span class="p">)</span> <span class="k">else</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">workdir</span> <span class="ow">or</span> <span class="n">DAEMON_WORKDIR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">umask</span> <span class="o">=</span> <span class="n">umask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fake</span> <span class="o">=</span> <span class="n">fake</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">after_chdir</span> <span class="o">=</span> <span class="n">after_chdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">after_forkers</span> <span class="o">=</span> <span class="n">after_forkers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdfds</span> <span class="o">=</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

<div class="viewcode-block" id="DaemonContext.redirect_to_null"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.DaemonContext.redirect_to_null">[docs]</a>    <span class="k">def</span> <span class="nf">redirect_to_null</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span></div>

<div class="viewcode-block" id="DaemonContext.open"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.DaemonContext.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_detach</span><span class="p">()</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">umask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">umask</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">after_chdir</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">after_chdir</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake</span><span class="p">:</span>
                <span class="c1"># We need to keep /dev/urandom from closing because</span>
                <span class="c1"># shelve needs it, and Beat needs shelve to start.</span>
                <span class="n">keep</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdfds</span><span class="p">)</span> <span class="o">+</span> <span class="n">fd_by_path</span><span class="p">([</span><span class="s1">'/dev/urandom'</span><span class="p">])</span>
                <span class="n">close_open_fds</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdfds</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redirect_to_null</span><span class="p">(</span><span class="n">maybe_fileno</span><span class="p">(</span><span class="n">fd</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">after_forkers</span> <span class="ow">and</span> <span class="n">mputil</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">mputil</span><span class="o">.</span><span class="n">_run_after_forkers</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span> <span class="o">=</span> <span class="bp">True</span></div>
    <span class="n">__enter__</span> <span class="o">=</span> <span class="nb">open</span>

<div class="viewcode-block" id="DaemonContext.close"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.DaemonContext.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span> <span class="o">=</span> <span class="bp">False</span></div>
    <span class="n">__exit__</span> <span class="o">=</span> <span class="n">close</span>

    <span class="k">def</span> <span class="nf">_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>      <span class="c1"># first child</span>
            <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">()</span>         <span class="c1"># create new session</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>   <span class="c1"># second child</span>
                <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="detached"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.detached">[docs]</a><span class="k">def</span> <span class="nf">detached</span><span class="p">(</span><span class="n">logfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pidfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">umask</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
             <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fake</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
    <span class="sd">"""Detach the current process in the background (daemonize).</span>

<span class="sd">    :keyword logfile: Optional log file.  The ability to write to this file</span>
<span class="sd">       will be verified before the process is detached.</span>
<span class="sd">    :keyword pidfile: Optional pidfile.  The pidfile will not be created,</span>
<span class="sd">      as this is the responsibility of the child.  But the process will</span>
<span class="sd">      exit if the pid lock exists and the pid written is still running.</span>
<span class="sd">    :keyword uid: Optional user id or user name to change</span>
<span class="sd">      effective privileges to.</span>
<span class="sd">    :keyword gid: Optional group id or group name to change effective</span>
<span class="sd">      privileges to.</span>
<span class="sd">    :keyword umask: Optional umask that will be effective in the child process.</span>
<span class="sd">    :keyword workdir: Optional new working directory.</span>
<span class="sd">    :keyword fake: Don't actually detach, intented for debugging purposes.</span>
<span class="sd">    :keyword \*\*opts: Ignored.</span>

<span class="sd">    **Example**:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from celery.platforms import detached, create_pidlock</span>

<span class="sd">        with detached(logfile='/var/log/app.log', pidfile='/var/run/app.pid',</span>
<span class="sd">                      uid='nobody'):</span>
<span class="sd">            # Now in detached child process with effective user set to nobody,</span>
<span class="sd">            # and we know that our logfile can be written to, and that</span>
<span class="sd">            # the pidfile is not locked.</span>
<span class="sd">            pidlock = create_pidlock('/var/run/app.pid')</span>

<span class="sd">            # Run the program</span>
<span class="sd">            program.run(logfile='/var/log/app.log')</span>

<span class="sd">    """</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'This platform does not support detach.'</span><span class="p">)</span>
    <span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="k">if</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">workdir</span>

    <span class="n">signals</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="s1">'SIGCLD'</span><span class="p">)</span>  <span class="c1"># Make sure SIGCLD is using the default handler.</span>
    <span class="n">maybe_drop_privileges</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="n">gid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_chdir_do</span><span class="p">():</span>
        <span class="c1"># Since without stderr any errors will be silently suppressed,</span>
        <span class="c1"># we need to know that we have access to the logfile.</span>
        <span class="n">logfile</span> <span class="ow">and</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># Doesn't actually create the pidfile, but makes sure it's not stale.</span>
        <span class="k">if</span> <span class="n">pidfile</span><span class="p">:</span>
            <span class="n">_create_pidlock</span><span class="p">(</span><span class="n">pidfile</span><span class="p">)</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">DaemonContext</span><span class="p">(</span>
        <span class="n">umask</span><span class="o">=</span><span class="n">umask</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">fake</span><span class="o">=</span><span class="n">fake</span><span class="p">,</span> <span class="n">after_chdir</span><span class="o">=</span><span class="n">after_chdir_do</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="parse_uid"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.parse_uid">[docs]</a><span class="k">def</span> <span class="nf">parse_uid</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
    <span class="sd">"""Parse user id.</span>

<span class="sd">    uid can be an integer (uid) or a string (user name), if a user name</span>
<span class="sd">    the uid is taken from the system user registry.</span>

<span class="sd">    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">pw_uid</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">'User does not exist: {0}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span></div>


<div class="viewcode-block" id="parse_gid"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.parse_gid">[docs]</a><span class="k">def</span> <span class="nf">parse_gid</span><span class="p">(</span><span class="n">gid</span><span class="p">):</span>
    <span class="sd">"""Parse group id.</span>

<span class="sd">    gid can be an integer (gid) or a string (group name), if a group name</span>
<span class="sd">    the gid is taken from the system group registry.</span>

<span class="sd">    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span><span class="o">.</span><span class="n">gr_gid</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">'Group does not exist: {0}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gid</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_setgroups_hack</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
    <span class="sd">""":fun:`setgroups` may have a platform-dependent limit,</span>
<span class="sd">    and it is not always possible to know in advance what this limit</span>
<span class="sd">    is, so we use this ugly hack stolen from glibc."""</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[:]</span>

    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">setgroups</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>   <span class="c1"># error from Python's check.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="n">groups</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># error from the OS.</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINVAL</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="n">groups</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<div class="viewcode-block" id="setgroups"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.setgroups">[docs]</a><span class="k">def</span> <span class="nf">setgroups</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
    <span class="sd">"""Set active groups from a list of group ids."""</span>
    <span class="n">max_groups</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">max_groups</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf</span><span class="p">(</span><span class="s1">'SC_NGROUPS_MAX'</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_setgroups_hack</span><span class="p">(</span><span class="n">groups</span><span class="p">[:</span><span class="n">max_groups</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPERM</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groups</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">getgroups</span><span class="p">()):</span>
            <span class="c1"># we shouldn't be allowed to change to this group.</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="initgroups"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.initgroups">[docs]</a><span class="k">def</span> <span class="nf">initgroups</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">):</span>
    <span class="sd">"""Compat version of :func:`os.initgroups` which was first</span>
<span class="sd">    added to Python 2.7."""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pwd</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">return</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">'initgroups'</span><span class="p">):</span>  <span class="c1"># Python 2.7+</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">initgroups</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">gr</span><span class="o">.</span><span class="n">gr_gid</span> <span class="k">for</span> <span class="n">gr</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrall</span><span class="p">()</span>
              <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">gr</span><span class="o">.</span><span class="n">gr_mem</span><span class="p">]</span>
    <span class="n">setgroups</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span></div>


<div class="viewcode-block" id="setgid"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.setgid">[docs]</a><span class="k">def</span> <span class="nf">setgid</span><span class="p">(</span><span class="n">gid</span><span class="p">):</span>
    <span class="sd">"""Version of :func:`os.setgid` supporting group names."""</span>
    <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">parse_gid</span><span class="p">(</span><span class="n">gid</span><span class="p">))</span></div>


<div class="viewcode-block" id="setuid"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.setuid">[docs]</a><span class="k">def</span> <span class="nf">setuid</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
    <span class="sd">"""Version of :func:`os.setuid` supporting usernames."""</span>
    <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">parse_uid</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span></div>


<div class="viewcode-block" id="maybe_drop_privileges"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.maybe_drop_privileges">[docs]</a><span class="k">def</span> <span class="nf">maybe_drop_privileges</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">"""Change process privileges to new user/group.</span>

<span class="sd">    If UID and GID is specified, the real user/group is changed.</span>

<span class="sd">    If only UID is specified, the real user is changed, and the group is</span>
<span class="sd">    changed to the users primary group.</span>

<span class="sd">    If only GID is specified, only the group is changed.</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">'win32'</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">():</span>
        <span class="c1"># no point trying to setuid unless we're root.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">'contact support'</span><span class="p">)</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span> <span class="ow">and</span> <span class="n">parse_uid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
    <span class="n">gid</span> <span class="o">=</span> <span class="n">gid</span> <span class="ow">and</span> <span class="n">parse_gid</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">uid</span><span class="p">:</span>
        <span class="c1"># If GID isn't defined, get the primary GID of the user.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gid</span> <span class="ow">and</span> <span class="n">pwd</span><span class="p">:</span>
            <span class="n">gid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">pw_gid</span>
        <span class="c1"># Must set the GID before initgroups(), as setgid()</span>
        <span class="c1"># is known to zap the group list on some platforms.</span>

        <span class="c1"># setgid must happen before setuid (otherwise the setgid operation</span>
        <span class="c1"># may fail because of insufficient privileges and possibly stay</span>
        <span class="c1"># in a privileged group).</span>
        <span class="n">setgid</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="n">initgroups</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>

        <span class="c1"># at last:</span>
        <span class="n">setuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="c1"># ... and make sure privileges cannot be restored:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">get_errno</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPERM</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">pass</span>  <span class="c1"># Good: cannot restore privileges.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">'non-root user able to restore privileges after setuid.'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gid</span> <span class="ow">and</span> <span class="n">setgid</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">uid</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">'Still root uid after drop privileges!'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gid</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">getgid</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getegid</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">'Still root gid after drop privileges!'</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">Signals</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""Convenience interface to :mod:`signals`.</span>

<span class="sd">    If the requested signal is not supported on the current platform,</span>
<span class="sd">    the operation will be ignored.</span>

<span class="sd">    **Examples**:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        &gt;&gt;&gt; from celery.platforms import signals</span>

<span class="sd">        &gt;&gt;&gt; from proj.handlers import my_handler</span>
<span class="sd">        &gt;&gt;&gt; signals['INT'] = my_handler</span>

<span class="sd">        &gt;&gt;&gt; signals['INT']</span>
<span class="sd">        my_handler</span>

<span class="sd">        &gt;&gt;&gt; signals.supported('INT')</span>
<span class="sd">        True</span>

<span class="sd">        &gt;&gt;&gt; signals.signum('INT')</span>
<span class="sd">        2</span>

<span class="sd">        &gt;&gt;&gt; signals.ignore('USR1')</span>
<span class="sd">        &gt;&gt;&gt; signals['USR1'] == signals.ignored</span>
<span class="sd">        True</span>

<span class="sd">        &gt;&gt;&gt; signals.reset('USR1')</span>
<span class="sd">        &gt;&gt;&gt; signals['USR1'] == signals.default</span>
<span class="sd">        True</span>

<span class="sd">        &gt;&gt;&gt; from proj.handlers import exit_handler, hup_handler</span>
<span class="sd">        &gt;&gt;&gt; signals.update(INT=exit_handler,</span>
<span class="sd">        ...                TERM=exit_handler,</span>
<span class="sd">        ...                HUP=hup_handler)</span>

<span class="sd">    """</span>

    <span class="n">ignored</span> <span class="o">=</span> <span class="n">_signal</span><span class="o">.</span><span class="n">SIG_IGN</span>
    <span class="n">default</span> <span class="o">=</span> <span class="n">_signal</span><span class="o">.</span><span class="n">SIG_DFL</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_signal</span><span class="p">,</span> <span class="s1">'setitimer'</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">arm_alarm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>
            <span class="n">_signal</span><span class="o">.</span><span class="n">setitimer</span><span class="p">(</span><span class="n">_signal</span><span class="o">.</span><span class="n">ITIMER_REAL</span><span class="p">,</span> <span class="n">seconds</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">itimer</span> <span class="kn">import</span> <span class="n">alarm</span> <span class="k">as</span> <span class="n">_itimer_alarm</span>  <span class="c1"># noqa</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">arm_alarm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>  <span class="c1"># noqa</span>
                <span class="n">_signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">seconds</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>

            <span class="k">def</span> <span class="nf">arm_alarm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>      <span class="c1"># noqa</span>
                <span class="k">return</span> <span class="n">_itimer_alarm</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>  <span class="c1"># noqa</span>

    <span class="k">def</span> <span class="nf">reset_alarm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">supported</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_name</span><span class="p">):</span>
        <span class="sd">"""Return true value if ``signal_name`` exists on this platform."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">signum</span><span class="p">(</span><span class="n">signal_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">signum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_name</span><span class="p">):</span>
        <span class="sd">"""Get signal number from signal name."""</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signal_name</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">signal_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signal_name</span><span class="p">,</span> <span class="n">string_t</span><span class="p">)</span> \
                <span class="ow">or</span> <span class="ow">not</span> <span class="n">signal_name</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'signal name must be uppercase string.'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">signal_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'SIG'</span><span class="p">):</span>
            <span class="n">signal_name</span> <span class="o">=</span> <span class="s1">'SIG'</span> <span class="o">+</span> <span class="n">signal_name</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_signal</span><span class="p">,</span> <span class="n">signal_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">signal_names</span><span class="p">):</span>
        <span class="sd">"""Reset signals to the default signal handler.</span>

<span class="sd">        Does nothing if the platform doesn't support signals,</span>
<span class="sd">        or the specified signal in particular.</span>

<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">sig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">)</span> <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">signal_names</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">signal_names</span><span class="p">):</span>
        <span class="sd">"""Ignore signal using :const:`SIG_IGN`.</span>

<span class="sd">        Does nothing if the platform doesn't support signals,</span>
<span class="sd">        or the specified signal in particular.</span>

<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">sig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignored</span><span class="p">)</span> <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">signal_names</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signum</span><span class="p">(</span><span class="n">signal_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_name</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="sd">"""Install signal handler.</span>

<span class="sd">        Does nothing if the current platform doesn't support signals,</span>
<span class="sd">        or the specified signal in particular.</span>

<span class="sd">        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signum</span><span class="p">(</span><span class="n">signal_name</span><span class="p">),</span> <span class="n">handler</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_d_</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">sigmap</span><span class="p">):</span>
        <span class="sd">"""Set signal handlers from a mapping."""</span>
        <span class="k">for</span> <span class="n">signal_name</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">items</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">_d_</span> <span class="ow">or</span> <span class="p">{},</span> <span class="o">**</span><span class="n">sigmap</span><span class="p">)):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">signal_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>

<span class="n">signals</span> <span class="o">=</span> <span class="n">Signals</span><span class="p">()</span>
<span class="n">get_signal</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">signum</span>                   <span class="c1"># compat</span>
<span class="n">install_signal_handler</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">__setitem__</span>  <span class="c1"># compat</span>
<span class="n">reset_signal</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">reset</span>                  <span class="c1"># compat</span>
<span class="n">ignore_signal</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">ignore</span>                <span class="c1"># compat</span>


<span class="k">def</span> <span class="nf">strargv</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="n">arg_start</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="s1">'manage'</span> <span class="ow">in</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">arg_start</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">arg_start</span><span class="p">:])</span>
    <span class="k">return</span> <span class="s1">''</span>


<div class="viewcode-block" id="set_process_title"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.set_process_title">[docs]</a><span class="k">def</span> <span class="nf">set_process_title</span><span class="p">(</span><span class="n">progname</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">"""Set the ps name for the currently running process.</span>

<span class="sd">    Only works if :mod:`setproctitle` is installed.</span>

<span class="sd">    """</span>
    <span class="n">proctitle</span> <span class="o">=</span> <span class="s1">'[{0}]'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">progname</span><span class="p">)</span>
    <span class="n">proctitle</span> <span class="o">=</span> <span class="s1">'{0} {1}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">proctitle</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="k">if</span> <span class="n">info</span> <span class="k">else</span> <span class="n">proctitle</span>
    <span class="k">if</span> <span class="n">_setproctitle</span><span class="p">:</span>
        <span class="n">_setproctitle</span><span class="o">.</span><span class="n">setproctitle</span><span class="p">(</span><span class="n">safe_str</span><span class="p">(</span><span class="n">proctitle</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">proctitle</span></div>


<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'NOSETPS'</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>

    <span class="k">def</span> <span class="nf">set_mp_process_title</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>

<div class="viewcode-block" id="set_mp_process_title"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.set_mp_process_title">[docs]</a>    <span class="k">def</span> <span class="nf">set_mp_process_title</span><span class="p">(</span><span class="n">progname</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>  <span class="c1"># noqa</span>
        <span class="sd">"""Set the ps name using the multiprocessing process name.</span>

<span class="sd">        Only works if :mod:`setproctitle` is installed.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">hostname</span><span class="p">:</span>
            <span class="n">progname</span> <span class="o">=</span> <span class="s1">'{0}: {1}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">progname</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">set_process_title</span><span class="p">(</span>
            <span class="s1">'{0}:{1}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">progname</span><span class="p">,</span> <span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_errno_name"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.get_errno_name">[docs]</a><span class="k">def</span> <span class="nf">get_errno_name</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">"""Get errno for string, e.g. ``ENOENT``."""</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">string_t</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span></div>


<span class="nd">@contextmanager</span>
<div class="viewcode-block" id="ignore_errno"><a class="viewcode-back" href="../../internals/reference/celery.platforms.html#celery.platforms.ignore_errno">[docs]</a><span class="k">def</span> <span class="nf">ignore_errno</span><span class="p">(</span><span class="o">*</span><span class="n">errnos</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""Context manager to ignore specific POSIX error codes.</span>

<span class="sd">    Takes a list of error codes to ignore, which can be either</span>
<span class="sd">    the name of the code, or the code integer itself::</span>

<span class="sd">        &gt;&gt;&gt; with ignore_errno('ENOENT'):</span>
<span class="sd">        ...     with open('foo', 'r') as fh:</span>
<span class="sd">        ...         return fh.read()</span>

<span class="sd">        &gt;&gt;&gt; with ignore_errno(errno.ENOENT, errno.EPERM):</span>
<span class="sd">        ...    pass</span>

<span class="sd">    :keyword types: A tuple of exceptions to ignore (when the errno matches),</span>
<span class="sd">                    defaults to :exc:`Exception`.</span>
<span class="sd">    """</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'types'</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">errnos</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_errno_name</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="k">for</span> <span class="n">errno</span> <span class="ow">in</span> <span class="n">errnos</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="n">types</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="s1">'errno'</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">errnos</span><span class="p">:</span>
            <span class="k">raise</span></div>


<span class="k">def</span> <span class="nf">check_privileges</span><span class="p">(</span><span class="n">accept_content</span><span class="p">):</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">'getuid'</span><span class="p">)</span> <span class="k">else</span> <span class="mi">65535</span>
    <span class="n">gid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getgid</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">'getgid'</span><span class="p">)</span> <span class="k">else</span> <span class="mi">65535</span>
    <span class="n">euid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">'geteuid'</span><span class="p">)</span> <span class="k">else</span> <span class="mi">65535</span>
    <span class="n">egid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getegid</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">'getegid'</span><span class="p">)</span> <span class="k">else</span> <span class="mi">65535</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">'fchown'</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'getuid'</span><span class="p">,</span> <span class="s1">'getgid'</span><span class="p">,</span> <span class="s1">'geteuid'</span><span class="p">,</span> <span class="s1">'getegid'</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">'suspicious platform, contact support'</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">uid</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">gid</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">euid</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">egid</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">'pickle'</span> <span class="ow">in</span> <span class="n">accept_content</span> <span class="ow">or</span>
                <span class="s1">'application/x-python-serialize'</span> <span class="ow">in</span> <span class="n">accept_content</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">C_FORCE_ROOT</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">ROOT_DISALLOWED</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">euid</span><span class="o">=</span><span class="n">euid</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="n">gid</span><span class="p">,</span> <span class="n">egid</span><span class="o">=</span><span class="n">egid</span><span class="p">,</span>
                    <span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">RuntimeWarning</span><span class="p">(</span><span class="n">ROOT_DISCOURAGED</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">euid</span><span class="o">=</span><span class="n">euid</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="n">gid</span><span class="p">,</span> <span class="n">egid</span><span class="o">=</span><span class="n">egid</span><span class="p">,</span>
        <span class="p">)))</span>
</pre></div>
</div>
</div>
</div>

<div class="clearer"></div>
</div>

<div class="footer" role="contentinfo">
        Â© <a href="../../copyright.html">Copyright</a> 2009-2015, Ask Solem &amp; Contributors.
    </div>
</body>
</html>