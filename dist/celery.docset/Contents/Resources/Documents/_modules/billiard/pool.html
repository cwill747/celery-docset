<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>billiard.pool â€” Celery 3.1.23 documentation</title>
<link href="../../_static/celery.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.1.23',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
<script src="../../_static/jquery.js" type="text/javascript"></script>
<script src="../../_static/underscore.js" type="text/javascript"></script>
<script src="../../_static/doctools.js" type="text/javascript"></script>
<link href="../../copyright.html" rel="copyright" title="Copyright"/>
<link href="../../index.html" rel="top" title="Celery 3.1.23 documentation"/>
<link href="../index.html" rel="up" title="Module code"/>
</head>
<body role="document">

<div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<div class="deck">
<p>
        This document describes the current stable version of Celery (3.1). For development docs,
        <a href="http://docs.celeryproject.org/en/master/_modules/billiard/pool.html">go here</a>.
        </p>
</div>
<h1>Source code for billiard.pool</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># Module providing the `Pool` class for managing a process pool</span>
<span class="c1">#</span>
<span class="c1"># multiprocessing/pool.py</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2006-2008, R Oudkerk</span>
<span class="c1"># Licensed to PSF under a Contributor Agreement.</span>
<span class="c1">#</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="c1">#</span>
<span class="c1"># Imports</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">Process</span><span class="p">,</span> <span class="n">cpu_count</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">.common</span> <span class="kn">import</span> <span class="n">pickle_loads</span><span class="p">,</span> <span class="n">reset_signals</span><span class="p">,</span> <span class="n">restart_state</span>
<span class="kn">from</span> <span class="nn">.compat</span> <span class="kn">import</span> <span class="n">get_errno</span><span class="p">,</span> <span class="n">send_offset</span>
<span class="kn">from</span> <span class="nn">.einfo</span> <span class="kn">import</span> <span class="n">ExceptionInfo</span>
<span class="kn">from</span> <span class="nn">.dummy</span> <span class="kn">import</span> <span class="n">DummyProcess</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CoroStop</span><span class="p">,</span>
    <span class="n">RestartFreqExceeded</span><span class="p">,</span>
    <span class="n">SoftTimeLimitExceeded</span><span class="p">,</span>
    <span class="n">Terminated</span><span class="p">,</span>
    <span class="n">TimeLimitExceeded</span><span class="p">,</span>
    <span class="n">TimeoutError</span><span class="p">,</span>
    <span class="n">WorkerLostError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.five</span> <span class="kn">import</span> <span class="n">Empty</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">reraise</span><span class="p">,</span> <span class="n">monotonic</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">Finalize</span><span class="p">,</span> <span class="n">debug</span>

<span class="n">PY3</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>

<span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'Windows'</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="c1"># On Windows os.kill calls TerminateProcess which cannot be</span>
    <span class="c1"># handled by # any process, so this is needed to terminate the task</span>
    <span class="c1"># *and its children* (if any).</span>
    <span class="kn">from</span> <span class="nn">._win</span> <span class="kn">import</span> <span class="n">kill_processtree</span> <span class="k">as</span> <span class="n">_kill</span>  <span class="c1"># noqa</span>
    <span class="n">SIGKILL</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">kill</span> <span class="k">as</span> <span class="n">_kill</span>                 <span class="c1"># noqa</span>
    <span class="n">SIGKILL</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span>


<span class="k">try</span><span class="p">:</span>
    <span class="n">TIMEOUT_MAX</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">TIMEOUT_MAX</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">TIMEOUT_MAX</span> <span class="o">=</span> <span class="mf">1e10</span>  <span class="c1"># noqa</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="n">_Semaphore</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Semaphore</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Semaphore is a factory function pointing to _Semaphore</span>
    <span class="n">_Semaphore</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">_Semaphore</span>  <span class="c1"># noqa</span>

<span class="n">SIGMAP</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'SIG'</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># Constants representing the state of a pool</span>
<span class="c1">#</span>

<span class="n">RUN</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">CLOSE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">TERMINATE</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1">#</span>
<span class="c1"># Constants representing the state of a job</span>
<span class="c1">#</span>

<span class="n">ACK</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">READY</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">TASK</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">NACK</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">DEATH</span> <span class="o">=</span> <span class="mi">4</span>

<span class="c1">#</span>
<span class="c1"># Exit code constants</span>
<span class="c1">#</span>
<span class="n">EX_OK</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">EX_FAILURE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">EX_RECYCLE</span> <span class="o">=</span> <span class="mh">0x9B</span>


<span class="c1"># Signal used for soft time limits.</span>
<span class="n">SIG_SOFT_TIMEOUT</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">"SIGUSR1"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># Miscellaneous</span>
<span class="c1">#</span>

<span class="n">LOST_WORKER_TIMEOUT</span> <span class="o">=</span> <span class="mf">10.0</span>
<span class="n">EX_OK</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">"EX_OK"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">job_counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

<span class="n">Lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span>


<span class="k">def</span> <span class="nf">_get_send_offset</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">native</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">send_offset</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">native</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">native</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">partial</span><span class="p">(</span><span class="n">send_offset</span><span class="p">,</span> <span class="n">connection</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">native</span>


<span class="k">def</span> <span class="nf">human_status</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">'signal {0} ({1})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">status</span><span class="p">,</span> <span class="n">SIGMAP</span><span class="p">[</span><span class="o">-</span><span class="n">status</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">'signal {0}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">status</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">'exitcode {0}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">mapstar</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">starmapstar</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">_logger</span><span class="p">:</span>
        <span class="n">util</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">stop_if_not_current</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">():</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LaxBoundedSemaphore</span><span class="p">(</span><span class="n">_Semaphore</span><span class="p">):</span>
    <span class="sd">"""Semaphore that checks that # release is &lt;= # acquires,</span>
<span class="sd">    but ignores if # releases &gt;= value."""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
            <span class="n">_Semaphore</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_Semaphore</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">shrink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_value</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span>
            <span class="k">with</span> <span class="n">cond</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">cond</span><span class="o">.</span><span class="n">notify_all</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_value</span><span class="p">:</span>
                <span class="n">_Semaphore</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">grow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_initial_value</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">grow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Semaphore__cond</span>
            <span class="k">with</span> <span class="n">cond</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_initial_value</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Semaphore__value</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Semaphore__cond</span>
            <span class="k">with</span> <span class="n">cond</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Semaphore__value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Semaphore__value</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">cond</span><span class="o">.</span><span class="n">notifyAll</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Semaphore__value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_value</span><span class="p">:</span>
                <span class="n">_Semaphore</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># Exceptions</span>
<span class="c1">#</span>


<span class="k">class</span> <span class="nc">MaybeEncodingError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">"""Wraps possible unpickleable errors, so they can be</span>
<span class="sd">    safely sent through the socket."""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exc</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MaybeEncodingError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"&lt;MaybeEncodingError: </span><span class="si">%s</span><span class="s2">&gt;"</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"Error sending result: '</span><span class="si">%r</span><span class="s2">'. Reason: '</span><span class="si">%r</span><span class="s2">'."</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exc</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">WorkersJoined</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">"""All workers have terminated."""</span>


<span class="k">def</span> <span class="nf">soft_timeout_sighandler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">SoftTimeLimitExceeded</span><span class="p">()</span>

<span class="c1">#</span>
<span class="c1"># Code run by worker processes</span>
<span class="c1">#</span>


<span class="k">class</span> <span class="nc">Worker</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="n">_controlled_termination</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">_job_terminated</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inq</span><span class="p">,</span> <span class="n">outq</span><span class="p">,</span> <span class="n">synq</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="p">(),</span>
                 <span class="n">maxtasks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sentinel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">on_exit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">sigprotection</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">maxtasks</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">maxtasks</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">maxtasks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initializer</span> <span class="o">=</span> <span class="n">initializer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initargs</span> <span class="o">=</span> <span class="n">initargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxtasks</span> <span class="o">=</span> <span class="n">maxtasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown</span> <span class="o">=</span> <span class="n">sentinel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_exit</span> <span class="o">=</span> <span class="n">on_exit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigprotection</span> <span class="o">=</span> <span class="n">sigprotection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">synq</span> <span class="o">=</span> <span class="n">inq</span><span class="p">,</span> <span class="n">outq</span><span class="p">,</span> <span class="n">synq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_shortcuts</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Worker</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">synq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initializer</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxtasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_shortcuts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inqW_fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inq</span><span class="o">.</span><span class="n">_writer</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>    <span class="c1"># inqueue write fd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outqR_fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outq</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>  <span class="c1"># outqueue read fd</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">synqR_fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synq</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>  <span class="c1"># synqueue read fd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">synqW_fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synq</span><span class="o">.</span><span class="n">_writer</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>  <span class="c1"># synqueue write fd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_syn_offset</span> <span class="o">=</span> <span class="n">_get_send_offset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synq</span><span class="o">.</span><span class="n">_writer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">synqR_fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synqW_fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_syn_offset</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quick_put</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inq</span><span class="o">.</span><span class="n">_writer</span><span class="o">.</span><span class="n">send</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quick_get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outq</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">recv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_job_offset</span> <span class="o">=</span> <span class="n">_get_send_offset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inq</span><span class="o">.</span><span class="n">_writer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_exit</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span>
        <span class="n">_exitcode</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="n">_exitcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
            <span class="k">return</span> <span class="n">_exit</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span> <span class="o">=</span> <span class="nb">exit</span>

        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_make_child_methods</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">after_fork</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_loop_start</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>  <span class="c1"># callback on loop start</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workloop</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">'Pool process </span><span class="si">%r</span><span class="s1"> error: </span><span class="si">%r</span><span class="s1">'</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_exit</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">_exitcode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exc</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_exit</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">_exitcode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_do_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exitcode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">exitcode</span> <span class="o">=</span> <span class="n">EX_FAILURE</span> <span class="k">if</span> <span class="n">exc</span> <span class="k">else</span> <span class="n">EX_OK</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_exit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_exit</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">'win32'</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outq</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">DEATH</span><span class="p">,</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">)))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="n">exitcode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="n">exitcode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_loop_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">terminate_controlled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controlled_termination</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">prepare_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">workloop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="n">monotonic</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="n">put</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outq</span><span class="o">.</span><span class="n">put</span>
        <span class="n">inqW_fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inqW_fd</span>
        <span class="n">synqW_fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synqW_fd</span>
        <span class="n">maxtasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxtasks</span>
        <span class="n">prepare_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_result</span>

        <span class="n">wait_for_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_job</span>
        <span class="n">_wait_for_syn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_syn</span>

        <span class="k">def</span> <span class="nf">wait_for_syn</span><span class="p">(</span><span class="n">jid</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s1">'!!!WAIT FOR ACK TIMEOUT: job:</span><span class="si">%r</span><span class="s1"> fd:</span><span class="si">%r</span><span class="s1">!!!'</span><span class="p">,</span>
                          <span class="n">jid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">synq</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">_wait_for_syn</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">req</span><span class="p">:</span>
                    <span class="n">type_</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">req</span>
                    <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="n">NACK</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">False</span>
                    <span class="k">assert</span> <span class="n">type_</span> <span class="o">==</span> <span class="n">ACK</span>
                    <span class="k">return</span> <span class="bp">True</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">completed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">maxtasks</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">maxtasks</span> <span class="ow">and</span> <span class="n">completed</span> <span class="o">&lt;</span> <span class="n">maxtasks</span><span class="p">):</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">wait_for_job</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">req</span><span class="p">:</span>
                <span class="n">type_</span><span class="p">,</span> <span class="n">args_</span> <span class="o">=</span> <span class="n">req</span>
                <span class="k">assert</span> <span class="n">type_</span> <span class="o">==</span> <span class="n">TASK</span>
                <span class="n">job</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">args_</span>
                <span class="n">put</span><span class="p">((</span><span class="n">ACK</span><span class="p">,</span> <span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">(),</span> <span class="n">pid</span><span class="p">,</span> <span class="n">synqW_fd</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">_wait_for_syn</span><span class="p">:</span>
                    <span class="n">confirm</span> <span class="o">=</span> <span class="n">wait_for_syn</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">:</span>
                        <span class="k">continue</span>  <span class="c1"># received NACK</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">prepare_result</span><span class="p">(</span><span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">ExceptionInfo</span><span class="p">())</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">put</span><span class="p">((</span><span class="n">READY</span><span class="p">,</span> <span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">inqW_fd</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">MaybeEncodingError</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">einfo</span> <span class="o">=</span> <span class="n">ExceptionInfo</span><span class="p">((</span>
                            <span class="n">MaybeEncodingError</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span>
                        <span class="p">))</span>
                        <span class="n">put</span><span class="p">((</span><span class="n">READY</span><span class="p">,</span> <span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">einfo</span><span class="p">),</span> <span class="n">inqW_fd</span><span class="p">)))</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="k">del</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
                <span class="n">completed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'worker exiting after </span><span class="si">%d</span><span class="s1"> tasks'</span><span class="p">,</span> <span class="n">completed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maxtasks</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">EX_RECYCLE</span> <span class="k">if</span> <span class="n">completed</span> <span class="o">==</span> <span class="n">maxtasks</span> <span class="k">else</span> <span class="n">EX_FAILURE</span>
        <span class="k">return</span> <span class="n">EX_OK</span>

    <span class="k">def</span> <span class="nf">after_fork</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inq</span><span class="p">,</span> <span class="s1">'_writer'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inq</span><span class="o">.</span><span class="n">_writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outq</span><span class="p">,</span> <span class="s1">'_reader'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outq</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initializer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initializer</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">initargs</span><span class="p">)</span>

        <span class="c1"># Make sure all exiting signals call finally: blocks.</span>
        <span class="c1"># This is important for the semaphore to be released.</span>
        <span class="n">reset_signals</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigprotection</span><span class="p">)</span>

        <span class="c1"># install signal handler for soft timeouts.</span>
        <span class="k">if</span> <span class="n">SIG_SOFT_TIMEOUT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">SIG_SOFT_TIMEOUT</span><span class="p">,</span> <span class="n">soft_timeout_sighandler</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_make_recv_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="n">get</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">get</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s1">'_reader'</span><span class="p">):</span>
            <span class="n">_poll</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">poll</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s1">'get_payload'</span><span class="p">)</span> <span class="ow">and</span> <span class="n">conn</span><span class="o">.</span><span class="n">get_payload</span><span class="p">:</span>
                <span class="n">get_payload</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">get_payload</span>

                <span class="k">def</span> <span class="nf">_recv</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">loads</span><span class="o">=</span><span class="n">pickle_loads</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">loads</span><span class="p">(</span><span class="n">get_payload</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">_recv</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>  <span class="c1"># noqa</span>
                    <span class="k">if</span> <span class="n">_poll</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
                        <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">get</span><span class="p">()</span>
                    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">_recv</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>  <span class="c1"># noqa</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">_recv</span>

    <span class="k">def</span> <span class="nf">_make_child_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loads</span><span class="o">=</span><span class="n">pickle_loads</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_protected_receive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_syn</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_protected_receive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synq</span><span class="p">)</span>
                             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synq</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_protected_receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="n">_receive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_recv_method</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">should_shutdown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown</span><span class="o">.</span><span class="n">is_set</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown</span> <span class="k">else</span> <span class="bp">None</span>

        <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">should_shutdown</span> <span class="ow">and</span> <span class="n">should_shutdown</span><span class="p">():</span>
                <span class="n">debug</span><span class="p">(</span><span class="s1">'worker got sentinel -- exiting'</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">EX_OK</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ready</span><span class="p">,</span> <span class="n">req</span> <span class="o">=</span> <span class="n">_receive</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ready</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">EOFError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">get_errno</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>  <span class="c1"># interrupted, maybe by gdb</span>
                <span class="n">debug</span><span class="p">(</span><span class="s1">'worker got </span><span class="si">%s</span><span class="s1"> -- exiting'</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">EX_FAILURE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">req</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">debug</span><span class="p">(</span><span class="s1">'worker got sentinel -- exiting'</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">EX_FAILURE</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">req</span>

        <span class="k">return</span> <span class="n">receive</span>


<span class="c1">#</span>
<span class="c1"># Class representing a process pool</span>
<span class="c1">#</span>


<span class="k">class</span> <span class="nc">PoolThread</span><span class="p">(</span><span class="n">DummyProcess</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">DummyProcess</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">RUN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_was_started</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">RestartFreqExceeded</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">"Thread </span><span class="si">%r</span><span class="s2"> crashed: </span><span class="si">%r</span><span class="s2">"</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span>
                  <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">_kill</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">"Thread </span><span class="si">%r</span><span class="s2"> crashed: </span><span class="si">%r</span><span class="s2">"</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span>
                  <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_was_started</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PoolThread</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_stop_not_started</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_was_started</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_stop_not_started</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">TERMINATE</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">CLOSE</span>


<span class="k">class</span> <span class="nc">Supervisor</span><span class="p">(</span><span class="n">PoolThread</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Supervisor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'worker handler starting'</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># do a burst at startup to verify that we can start</span>
            <span class="c1"># our pool processes, and in that time we lower</span>
            <span class="c1"># the max restart frequency.</span>
            <span class="n">prev_state</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">restart_state</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">restart_state</span> <span class="o">=</span> <span class="n">restart_state</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">pool</span><span class="o">.</span><span class="n">_processes</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span> <span class="ow">and</span> <span class="n">pool</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span><span class="p">:</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">_maintain_pool</span><span class="p">()</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

            <span class="c1"># Keep maintaing workers until the cache gets drained, unless</span>
            <span class="c1"># the pool is termianted</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">restart_state</span> <span class="o">=</span> <span class="n">prev_state</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span> <span class="ow">and</span> <span class="n">pool</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span><span class="p">:</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">_maintain_pool</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RestartFreqExceeded</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'worker handler exiting'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TaskHandler</span><span class="p">(</span><span class="n">PoolThread</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taskqueue</span><span class="p">,</span> <span class="n">put</span><span class="p">,</span> <span class="n">outqueue</span><span class="p">,</span> <span class="n">pool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskqueue</span> <span class="o">=</span> <span class="n">taskqueue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">put</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outqueue</span> <span class="o">=</span> <span class="n">outqueue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">taskqueue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskqueue</span>
        <span class="n">put</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span>

        <span class="k">for</span> <span class="n">taskseq</span><span class="p">,</span> <span class="n">set_length</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">taskqueue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">taskseq</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">:</span>
                        <span class="n">debug</span><span class="p">(</span><span class="s1">'task handler found thread._state != RUN'</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                        <span class="n">debug</span><span class="p">(</span><span class="s1">'could not put task on queue'</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">set_length</span><span class="p">:</span>
                        <span class="n">debug</span><span class="p">(</span><span class="s1">'doing set_length()'</span><span class="p">)</span>
                        <span class="n">set_length</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">'Task Handler ERROR: </span><span class="si">%r</span><span class="s1">'</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">debug</span><span class="p">(</span><span class="s1">'task handler got sentinel'</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tell_others</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tell_others</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">outqueue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outqueue</span>
        <span class="n">put</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># tell result handler to finish when cache is empty</span>
            <span class="n">debug</span><span class="p">(</span><span class="s1">'task handler sending sentinel to result handler'</span><span class="p">)</span>
            <span class="n">outqueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

            <span class="c1"># tell workers there is no more work</span>
            <span class="n">debug</span><span class="p">(</span><span class="s1">'task handler sending sentinel to workers'</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">put</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">debug</span><span class="p">(</span><span class="s1">'task handler got IOError when sending sentinels'</span><span class="p">)</span>

        <span class="n">debug</span><span class="p">(</span><span class="s1">'task handler exiting'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_stop_not_started</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tell_others</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">TimeoutHandler</span><span class="p">(</span><span class="n">PoolThread</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processes</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">t_soft</span><span class="p">,</span> <span class="n">t_hard</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="n">processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_soft</span> <span class="o">=</span> <span class="n">t_soft</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_hard</span> <span class="o">=</span> <span class="n">t_hard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_it</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TimeoutHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_process_by_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">((</span>
            <span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">proc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="n">pid</span>
        <span class="p">),</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">on_soft_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'soft time limit exceeded for </span><span class="si">%r</span><span class="s1">'</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
        <span class="n">process</span><span class="p">,</span> <span class="n">_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_by_pid</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">_worker_pid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">process</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Run timeout callback</span>
        <span class="n">job</span><span class="o">.</span><span class="n">handle_timeout</span><span class="p">(</span><span class="n">soft</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_kill</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">_worker_pid</span><span class="p">,</span> <span class="n">SIG_SOFT_TIMEOUT</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">get_errno</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ESRCH</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">on_hard_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'hard time limit exceeded for </span><span class="si">%r</span><span class="s1">'</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
        <span class="c1"># Remove from cache and set return value to an exception</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TimeLimitExceeded</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">_timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">TimeLimitExceeded</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">ExceptionInfo</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">pass</span>

        <span class="c1"># Remove from _pool</span>
        <span class="n">process</span><span class="p">,</span> <span class="n">_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_by_pid</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">_worker_pid</span><span class="p">)</span>

        <span class="c1"># Run timeout callback</span>
        <span class="n">job</span><span class="o">.</span><span class="n">handle_timeout</span><span class="p">(</span><span class="n">soft</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">process</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trywaitkill</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_trywaitkill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'timeout: sending TERM to </span><span class="si">%s</span><span class="s1">'</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">worker</span><span class="o">.</span><span class="n">_popen</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
                <span class="k">return</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'timeout: TERM timed-out, now sending KILL to </span><span class="si">%s</span><span class="s1">'</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_kill</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">handle_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span>
        <span class="n">t_hard</span><span class="p">,</span> <span class="n">t_soft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_hard</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_soft</span>
        <span class="n">dirty</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">on_soft_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_soft_timeout</span>
        <span class="n">on_hard_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_hard_timeout</span>

        <span class="k">def</span> <span class="nf">_timed_out</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">start</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">monotonic</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="c1"># Inner-loop</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span><span class="p">:</span>

            <span class="c1"># Remove dirty items not in cache anymore</span>
            <span class="k">if</span> <span class="n">dirty</span><span class="p">:</span>
                <span class="n">dirty</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dirty</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">ack_time</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">_time_accepted</span>
                <span class="n">soft_timeout</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">_soft_timeout</span>
                <span class="k">if</span> <span class="n">soft_timeout</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">soft_timeout</span> <span class="o">=</span> <span class="n">t_soft</span>
                <span class="n">hard_timeout</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">_timeout</span>
                <span class="k">if</span> <span class="n">hard_timeout</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">hard_timeout</span> <span class="o">=</span> <span class="n">t_hard</span>
                <span class="k">if</span> <span class="n">_timed_out</span><span class="p">(</span><span class="n">ack_time</span><span class="p">,</span> <span class="n">hard_timeout</span><span class="p">):</span>
                    <span class="n">on_hard_timeout</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dirty</span> <span class="ow">and</span> <span class="n">_timed_out</span><span class="p">(</span><span class="n">ack_time</span><span class="p">,</span> <span class="n">soft_timeout</span><span class="p">):</span>
                    <span class="n">on_soft_timeout</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                    <span class="n">dirty</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">yield</span>

    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_timeouts</span><span class="p">():</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># don't spin</span>
            <span class="k">except</span> <span class="n">CoroStop</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'timeout handler exiting'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_it</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_timeouts</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_it</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_it</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">ResultHandler</span><span class="p">(</span><span class="n">PoolThread</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outqueue</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">poll</span><span class="p">,</span>
                 <span class="n">join_exited_workers</span><span class="p">,</span> <span class="n">putlock</span><span class="p">,</span> <span class="n">restart_state</span><span class="p">,</span>
                 <span class="n">check_timeouts</span><span class="p">,</span> <span class="n">on_job_ready</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outqueue</span> <span class="o">=</span> <span class="n">outqueue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">get</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">poll</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_exited_workers</span> <span class="o">=</span> <span class="n">join_exited_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putlock</span> <span class="o">=</span> <span class="n">putlock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_state</span> <span class="o">=</span> <span class="n">restart_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_it</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_complete</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_timeouts</span> <span class="o">=</span> <span class="n">check_timeouts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_job_ready</span> <span class="o">=</span> <span class="n">on_job_ready</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_methods</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResultHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_stop_not_started</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># used when pool started without result handler thread.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish_at_shutdown</span><span class="p">(</span><span class="n">handle_timeouts</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span>
        <span class="n">putlock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">putlock</span>
        <span class="n">restart_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_state</span>
        <span class="n">on_job_ready</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_job_ready</span>

        <span class="k">def</span> <span class="nf">on_ack</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">time_accepted</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">synqW_fd</span><span class="p">):</span>
            <span class="n">restart_state</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cache</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">_ack</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">time_accepted</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">synqW_fd</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="c1"># Object gone or doesn't support _ack (e.g. IMAPIterator).</span>
                <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">on_ready</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">inqW_fd</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">on_job_ready</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">on_job_ready</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">inqW_fd</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">job</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">putlock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">putlock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">on_death</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">get_errno</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ESRCH</span><span class="p">:</span>
                    <span class="k">raise</span>

        <span class="n">state_handlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ACK</span><span class="p">:</span> <span class="n">on_ack</span><span class="p">,</span> <span class="n">READY</span><span class="p">:</span> <span class="n">on_ready</span><span class="p">,</span> <span class="n">DEATH</span><span class="p">:</span> <span class="n">on_death</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">on_state_change</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">task</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">state_handlers</span><span class="p">[</span><span class="n">state</span><span class="p">](</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">debug</span><span class="p">(</span><span class="s2">"Unknown job state: </span><span class="si">%s</span><span class="s2"> (args=</span><span class="si">%s</span><span class="s2">)"</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_state_change</span> <span class="o">=</span> <span class="n">on_state_change</span>

    <span class="k">def</span> <span class="nf">_process_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">poll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poll</span>
        <span class="n">on_state_change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_state_change</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ready</span><span class="p">,</span> <span class="n">task</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">debug</span><span class="p">(</span><span class="s1">'result handler got </span><span class="si">%r</span><span class="s1"> -- exiting'</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">CoroStop</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">TERMINATE</span>
                <span class="n">debug</span><span class="p">(</span><span class="s1">'result handler found thread._state=TERMINATE'</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">CoroStop</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">ready</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">debug</span><span class="p">(</span><span class="s1">'result handler got sentinel'</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">CoroStop</span><span class="p">()</span>
                <span class="n">on_state_change</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">timeout</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># blocking</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">yield</span>

    <span class="k">def</span> <span class="nf">handle_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileno</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_it</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_result</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># non-blocking</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_it</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">StopIteration</span><span class="p">,</span> <span class="n">CoroStop</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_it</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'result handler starting'</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_result</span><span class="p">(</span><span class="mf">1.0</span><span class="p">):</span>  <span class="c1"># blocking</span>
                        <span class="k">pass</span>
                <span class="k">except</span> <span class="n">CoroStop</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish_at_shutdown</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">finish_at_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle_timeouts</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_complete</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span>
        <span class="n">outqueue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outqueue</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span>
        <span class="n">poll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poll</span>
        <span class="n">join_exited_workers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_exited_workers</span>
        <span class="n">check_timeouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_timeouts</span>
        <span class="n">on_state_change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_state_change</span>

        <span class="n">time_terminate</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">while</span> <span class="n">cache</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">TERMINATE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">check_timeouts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">check_timeouts</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ready</span><span class="p">,</span> <span class="n">task</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">debug</span><span class="p">(</span><span class="s1">'result handler got </span><span class="si">%r</span><span class="s1"> -- exiting'</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">ready</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">debug</span><span class="p">(</span><span class="s1">'result handler ignoring extra sentinel'</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">on_state_change</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">join_exited_workers</span><span class="p">(</span><span class="n">shutdown</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">WorkersJoined</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">monotonic</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">time_terminate</span><span class="p">:</span>
                    <span class="n">time_terminate</span> <span class="o">=</span> <span class="n">now</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">time_terminate</span> <span class="o">&gt;</span> <span class="mf">5.0</span><span class="p">:</span>
                        <span class="n">debug</span><span class="p">(</span><span class="s1">'result handler exiting: timed out'</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="n">debug</span><span class="p">(</span><span class="s1">'result handler: all workers terminated, '</span>
                          <span class="s1">'timeout in </span><span class="si">%s</span><span class="s1">s'</span><span class="p">,</span>
                          <span class="nb">abs</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">time_terminate</span> <span class="o">-</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">outqueue</span><span class="p">,</span> <span class="s1">'_reader'</span><span class="p">):</span>
            <span class="n">debug</span><span class="p">(</span><span class="s1">'ensuring that outqueue is not full'</span><span class="p">)</span>
            <span class="c1"># If we don't make room available in outqueue then</span>
            <span class="c1"># attempts to add the sentinel (None) to outqueue may</span>
            <span class="c1"># block.  There is guaranteed to be no more than 2 sentinels.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">outqueue</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">poll</span><span class="p">():</span>
                        <span class="k">break</span>
                    <span class="n">get</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">):</span>
                <span class="k">pass</span>

        <span class="n">debug</span><span class="p">(</span><span class="s1">'result handler exiting: len(cache)=</span><span class="si">%s</span><span class="s1">, thread._state=</span><span class="si">%s</span><span class="s1">'</span><span class="p">,</span>
              <span class="nb">len</span><span class="p">(</span><span class="n">cache</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Pool</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Class which supports an async version of applying functions to arguments.</span>
<span class="sd">    '''</span>
    <span class="n">Worker</span> <span class="o">=</span> <span class="n">Worker</span>
    <span class="n">Supervisor</span> <span class="o">=</span> <span class="n">Supervisor</span>
    <span class="n">TaskHandler</span> <span class="o">=</span> <span class="n">TaskHandler</span>
    <span class="n">TimeoutHandler</span> <span class="o">=</span> <span class="n">TimeoutHandler</span>
    <span class="n">ResultHandler</span> <span class="o">=</span> <span class="n">ResultHandler</span>
    <span class="n">SoftTimeLimitExceeded</span> <span class="o">=</span> <span class="n">SoftTimeLimitExceeded</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="p">(),</span>
                 <span class="n">maxtasksperchild</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">soft_timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">lost_worker_timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">max_restarts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_restart_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">on_process_up</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">on_process_down</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">on_timeout_set</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">on_timeout_cancel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">threads</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">semaphore</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">putlocks</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">allow_restart</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">synack</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">on_process_exit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synack</span> <span class="o">=</span> <span class="n">synack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_queues</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_taskqueue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">RUN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soft_timeout</span> <span class="o">=</span> <span class="n">soft_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maxtasksperchild</span> <span class="o">=</span> <span class="n">maxtasksperchild</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initializer</span> <span class="o">=</span> <span class="n">initializer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initargs</span> <span class="o">=</span> <span class="n">initargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_process_exit</span> <span class="o">=</span> <span class="n">on_process_exit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lost_worker_timeout</span> <span class="o">=</span> <span class="n">lost_worker_timeout</span> <span class="ow">or</span> <span class="n">LOST_WORKER_TIMEOUT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_process_up</span> <span class="o">=</span> <span class="n">on_process_up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_process_down</span> <span class="o">=</span> <span class="n">on_process_down</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_timeout_set</span> <span class="o">=</span> <span class="n">on_timeout_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_timeout_cancel</span> <span class="o">=</span> <span class="n">on_timeout_cancel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="n">threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_restart</span> <span class="o">=</span> <span class="n">allow_restart</span>

        <span class="k">if</span> <span class="n">soft_timeout</span> <span class="ow">and</span> <span class="n">SIG_SOFT_TIMEOUT</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">(</span>
                <span class="s2">"Soft timeouts are not supported: "</span>
                <span class="s2">"on this platform: It does not have the SIGUSR1 signal."</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="n">soft_timeout</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_processes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="k">if</span> <span class="n">processes</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_restarts</span> <span class="o">=</span> <span class="n">max_restarts</span> <span class="ow">or</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processes</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_state</span> <span class="o">=</span> <span class="n">restart_state</span><span class="p">(</span><span class="n">max_restarts</span><span class="p">,</span> <span class="n">max_restart_freq</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">initializer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">initializer</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'initializer must be a callable'</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">on_process_exit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">on_process_exit</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'on_process_exit must be callable'</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_poolctrl</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putlocks</span> <span class="o">=</span> <span class="n">putlocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_putlock</span> <span class="o">=</span> <span class="n">semaphore</span> <span class="ow">or</span> <span class="n">LaxBoundedSemaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_worker_process</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Supervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threads</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker_handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_task_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TaskHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_taskqueue</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_quick_put</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_outqueue</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threads</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_task_handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Thread killing timedout jobs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TimeoutHandler</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">soft_timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_handler_mutex</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_handler_started</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">soft_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_timeout_handler</span><span class="p">()</span>

        <span class="c1"># If running without threads, we need to check for timeouts</span>
        <span class="c1"># while waiting for unfinished work at shutdown.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_timeouts</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">threads</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_timeouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_handler</span><span class="o">.</span><span class="n">handle_event</span>

        <span class="c1"># Thread processing results in the outqueue.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_result_handler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_result_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_handler</span><span class="o">.</span><span class="n">handle_event</span>

        <span class="k">if</span> <span class="n">threads</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result_handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_terminate</span> <span class="o">=</span> <span class="n">Finalize</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_pool</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_taskqueue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inqueue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outqueue</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_handler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_handler</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_result_handler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_handler</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_help_stuff_finish_args</span><span class="p">()),</span>
            <span class="n">exitpriority</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_result_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ResultHandler</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outqueue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quick_get</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_poll_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_exited_workers</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_putlock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_timeouts</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_job_ready</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_job_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">inqW_fd</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_help_stuff_finish_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inqueue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_handler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span>

    <span class="k">def</span> <span class="nf">cpu_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cpu_count</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">handle_result_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_handler</span><span class="o">.</span><span class="n">handle_event</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_register_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">queues</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_process_by_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">((</span>
            <span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">proc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="n">pid</span>
        <span class="p">),</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_process_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inqueue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outqueue</span><span class="p">,</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_create_worker_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">sentinel</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_restart</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">inq</span><span class="p">,</span> <span class="n">outq</span><span class="p">,</span> <span class="n">synq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_process_queues</span><span class="p">()</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Worker</span><span class="p">(</span>
            <span class="n">inq</span><span class="p">,</span> <span class="n">outq</span><span class="p">,</span> <span class="n">synq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initializer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initargs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maxtasksperchild</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_process_exit</span><span class="p">,</span>
            <span class="c1"># Need to handle all signals if using the ipc semaphore,</span>
            <span class="c1"># to make sure the semaphore is released.</span>
            <span class="n">sigprotection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_register_queues</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="n">inq</span><span class="p">,</span> <span class="n">outq</span><span class="p">,</span> <span class="n">synq</span><span class="p">))</span>
        <span class="n">w</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'Process'</span><span class="p">,</span> <span class="s1">'PoolWorker'</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">w</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">w</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_poolctrl</span><span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sentinel</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_process_up</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_process_up</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">w</span>

    <span class="k">def</span> <span class="nf">process_flush_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_join_exited_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shutdown</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">"""Cleanup after any worker processes which have exited due to</span>
<span class="sd">        reaching their specified lifetime. Returns True if any workers were</span>
<span class="sd">        cleaned up.</span>
<span class="sd">        """</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># The worker may have published a result before being terminated,</span>
        <span class="c1"># but we have no way to accurately tell if it did.  So we wait for</span>
        <span class="c1"># _lost_worker_timeout seconds before we mark the job with</span>
        <span class="c1"># WorkerLostError.</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="p">[</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">ready</span><span class="p">()</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">_worker_lost</span><span class="p">]:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">now</span> <span class="ow">or</span> <span class="n">monotonic</span><span class="p">()</span>
            <span class="n">lost_time</span><span class="p">,</span> <span class="n">lost_ret</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">_worker_lost</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">lost_time</span> <span class="o">&gt;</span> <span class="n">job</span><span class="o">.</span><span class="n">_lost_worker_timeout</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mark_as_worker_lost</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">lost_ret</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shutdown</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">WorkersJoined</span><span class="p">()</span>

        <span class="n">cleaned</span><span class="p">,</span> <span class="n">exitcodes</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">))):</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">exitcode</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">exitcode</span>
            <span class="n">popen</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">_popen</span>
            <span class="k">if</span> <span class="n">popen</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">exitcode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># worker exited</span>
                <span class="n">debug</span><span class="p">(</span><span class="s1">'Supervisor: cleaning up worker </span><span class="si">%d</span><span class="s1">'</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">popen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="n">debug</span><span class="p">(</span><span class="s1">'Supervisor: worked </span><span class="si">%d</span><span class="s1"> joined'</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">cleaned</span><span class="p">[</span><span class="n">worker</span><span class="o">.</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">worker</span>
                <span class="n">exitcodes</span><span class="p">[</span><span class="n">worker</span><span class="o">.</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">exitcode</span>
                <span class="k">if</span> <span class="n">exitcode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">EX_OK</span><span class="p">,</span> <span class="n">EX_RECYCLE</span><span class="p">)</span> <span class="ow">and</span> \
                        <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s1">'_controlled_termination'</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                    <span class="n">error</span><span class="p">(</span>
                        <span class="s1">'Process </span><span class="si">%r</span><span class="s1"> pid:</span><span class="si">%r</span><span class="s1"> exited with </span><span class="si">%r</span><span class="s1">'</span><span class="p">,</span>
                        <span class="n">worker</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">human_status</span><span class="p">(</span><span class="n">exitcode</span><span class="p">),</span>
                        <span class="n">exc_info</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_flush_queues</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poolctrl</span><span class="p">[</span><span class="n">worker</span><span class="o">.</span><span class="n">pid</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cleaned</span><span class="p">:</span>
            <span class="n">all_pids</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">pid</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="n">acked_by_gone</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">pid</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">worker_pids</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">cleaned</span> <span class="ow">or</span> <span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_pids</span><span class="p">),</span>
                    <span class="bp">None</span>
                <span class="p">)</span>
                <span class="c1"># already accepted by process</span>
                <span class="k">if</span> <span class="n">acked_by_gone</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">on_job_process_down</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">acked_by_gone</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
                        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">exitcodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">acked_by_gone</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
                        <span class="n">proc</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">acked_by_gone</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">proc</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="s1">'_job_terminated'</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                            <span class="n">job</span><span class="o">.</span><span class="n">_set_terminated</span><span class="p">(</span><span class="n">exitcode</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">on_job_process_lost</span><span class="p">(</span>
                                <span class="n">job</span><span class="p">,</span> <span class="n">acked_by_gone</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">,</span>
                            <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># started writing to</span>
                    <span class="n">write_to</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">_write_to</span>
                    <span class="c1"># was scheduled to write to</span>
                    <span class="n">sched_for</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">_scheduled_for</span>

                    <span class="k">if</span> <span class="n">write_to</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">write_to</span><span class="o">.</span><span class="n">_is_alive</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">on_job_process_down</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">write_to</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">sched_for</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sched_for</span><span class="o">.</span><span class="n">_is_alive</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">on_job_process_down</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">sched_for</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">values</span><span class="p">(</span><span class="n">cleaned</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_process_down</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">shutdown</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_process_cleanup_queues</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">on_process_down</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">exitcodes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">on_partial_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_process_cleanup_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">on_job_process_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">pid_gone</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">on_job_process_lost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">):</span>
        <span class="n">job</span><span class="o">.</span><span class="n">_worker_lost</span> <span class="o">=</span> <span class="p">(</span><span class="n">monotonic</span><span class="p">(),</span> <span class="n">exitcode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mark_as_worker_lost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkerLostError</span><span class="p">(</span>
                <span class="s1">'Worker exited prematurely: {0}.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">human_status</span><span class="p">(</span><span class="n">exitcode</span><span class="p">)),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">WorkerLostError</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">ExceptionInfo</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc_info</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_grow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">on_shrink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">shrink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">worker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterinactive</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_processes</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_putlock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_putlock</span><span class="o">.</span><span class="n">shrink</span><span class="p">()</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">terminate_controlled</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_shrink</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Can't shrink pool. All processes busy!"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">grow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_processes</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_putlock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_putlock</span><span class="o">.</span><span class="n">grow</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_grow</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_iterinactive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_active</span><span class="p">(</span><span class="n">worker</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">worker</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_worker_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">worker</span><span class="o">.</span><span class="n">pid</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">worker_pids</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_repopulate_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exitcodes</span><span class="p">):</span>
        <span class="sd">"""Bring the number of pool processes up to the specified number,</span>
<span class="sd">        for use after reaping workers which have exited.</span>
<span class="sd">        """</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processes</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">RUN</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exitcodes</span> <span class="ow">and</span> <span class="n">exitcodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">EX_OK</span><span class="p">,</span> <span class="n">EX_RECYCLE</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">restart_state</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restart_state</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_worker_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_avail_index</span><span class="p">())</span>
            <span class="n">debug</span><span class="p">(</span><span class="s1">'added worker'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_avail_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processes</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processes</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">did_start_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_exited_workers</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_maintain_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">""""Clean up any exited workers and start replacements for them.</span>
<span class="sd">        """</span>
        <span class="n">joined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_exited_workers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_repopulate_pool</span><span class="p">(</span><span class="n">joined</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">joined</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_putlock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_putlock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">maintain_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_handler</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_maintain_pool</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">RestartFreqExceeded</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">get_errno</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOMEM</span><span class="p">:</span>
                    <span class="n">reraise</span><span class="p">(</span><span class="ne">MemoryError</span><span class="p">,</span>
                            <span class="ne">MemoryError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)),</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_setup_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">billiard.queues</span> <span class="kn">import</span> <span class="n">SimpleQueue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inqueue</span> <span class="o">=</span> <span class="n">SimpleQueue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outqueue</span> <span class="o">=</span> <span class="n">SimpleQueue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quick_put</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inqueue</span><span class="o">.</span><span class="n">_writer</span><span class="o">.</span><span class="n">send</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quick_get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outqueue</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">recv</span>

        <span class="k">def</span> <span class="nf">_poll_result</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outqueue</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quick_get</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_poll_result</span> <span class="o">=</span> <span class="n">_poll_result</span>

    <span class="k">def</span> <span class="nf">_start_timeout_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ensure more than one thread does not start the timeout handler</span>
        <span class="c1"># thread at once.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_handler_mutex</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_handler_started</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_handler_started</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwds</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">'''</span>
<span class="sd">        Equivalent of `func(*args, **kwargs)`.</span>
<span class="sd">        '''</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">starmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">'''</span>
<span class="sd">        Like `map()` method but the elements of the `iterable` are expected to</span>
<span class="sd">        be iterables as well and will be unpacked as arguments. Hence</span>
<span class="sd">        `func` and (a, b) becomes func(a, b).</span>
<span class="sd">        '''</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_async</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span>
                                   <span class="n">starmapstar</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">starmap_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">error_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">'''</span>
<span class="sd">        Asynchronous version of `starmap()` method.</span>
<span class="sd">        '''</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_async</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">starmapstar</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">,</span>
                                   <span class="n">callback</span><span class="p">,</span> <span class="n">error_callback</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">'''</span>
<span class="sd">        Apply `func` to each element in `iterable`, collecting the results</span>
<span class="sd">        in a list that is returned.</span>
<span class="sd">        '''</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_async</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">imap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lost_worker_timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">'''</span>
<span class="sd">        Equivalent of `map()` -- can be MUCH slower than `Pool.map()`.</span>
<span class="sd">        '''</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">RUN</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">lost_worker_timeout</span> <span class="o">=</span> <span class="n">lost_worker_timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lost_worker_timeout</span>
        <span class="k">if</span> <span class="n">chunksize</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">IMapIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span>
                                  <span class="n">lost_worker_timeout</span><span class="o">=</span><span class="n">lost_worker_timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_taskqueue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span>
                <span class="p">((</span><span class="n">TASK</span><span class="p">,</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,),</span> <span class="p">{}))</span>
                 <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterable</span><span class="p">)),</span>
                <span class="n">result</span><span class="o">.</span><span class="n">_set_length</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">chunksize</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="n">task_batches</span> <span class="o">=</span> <span class="n">Pool</span><span class="o">.</span><span class="n">_get_tasks</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">IMapIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span>
                                  <span class="n">lost_worker_timeout</span><span class="o">=</span><span class="n">lost_worker_timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_taskqueue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span>
                <span class="p">((</span><span class="n">TASK</span><span class="p">,</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mapstar</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,),</span> <span class="p">{}))</span>
                 <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">task_batches</span><span class="p">)),</span>
                <span class="n">result</span><span class="o">.</span><span class="n">_set_length</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">imap_unordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">lost_worker_timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">'''</span>
<span class="sd">        Like `imap()` method but ordering of results is arbitrary.</span>
<span class="sd">        '''</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">RUN</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">lost_worker_timeout</span> <span class="o">=</span> <span class="n">lost_worker_timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lost_worker_timeout</span>
        <span class="k">if</span> <span class="n">chunksize</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">IMapUnorderedIterator</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span> <span class="n">lost_worker_timeout</span><span class="o">=</span><span class="n">lost_worker_timeout</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_taskqueue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span>
                <span class="p">((</span><span class="n">TASK</span><span class="p">,</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,),</span> <span class="p">{}))</span>
                 <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterable</span><span class="p">)),</span>
                <span class="n">result</span><span class="o">.</span><span class="n">_set_length</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">chunksize</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="n">task_batches</span> <span class="o">=</span> <span class="n">Pool</span><span class="o">.</span><span class="n">_get_tasks</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">IMapUnorderedIterator</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span> <span class="n">lost_worker_timeout</span><span class="o">=</span><span class="n">lost_worker_timeout</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_taskqueue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span>
                <span class="p">((</span><span class="n">TASK</span><span class="p">,</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mapstar</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,),</span> <span class="p">{}))</span>
                 <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">task_batches</span><span class="p">)),</span>
                <span class="n">result</span><span class="o">.</span><span class="n">_set_length</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwds</span><span class="o">=</span><span class="p">{},</span>
                    <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">error_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">accept_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">timeout_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">waitforslot</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">soft_timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lost_worker_timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">callbacks_propagate</span><span class="o">=</span><span class="p">(),</span>
                    <span class="n">correlation_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">'''</span>
<span class="sd">        Asynchronous equivalent of `apply()` method.</span>

<span class="sd">        Callback is called when the functions return value is ready.</span>
<span class="sd">        The accept callback is called when the job is accepted to be executed.</span>

<span class="sd">        Simplified the flow is like this:</span>

<span class="sd">            &gt;&gt;&gt; def apply_async(func, args, kwds, callback, accept_callback):</span>
<span class="sd">            ...     if accept_callback:</span>
<span class="sd">            ...         accept_callback()</span>
<span class="sd">            ...     retval = func(*args, **kwds)</span>
<span class="sd">            ...     if callback:</span>
<span class="sd">            ...         callback(retval)</span>

<span class="sd">        '''</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">RUN</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">soft_timeout</span> <span class="o">=</span> <span class="n">soft_timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">soft_timeout</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="n">lost_worker_timeout</span> <span class="o">=</span> <span class="n">lost_worker_timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lost_worker_timeout</span>
        <span class="k">if</span> <span class="n">soft_timeout</span> <span class="ow">and</span> <span class="n">SIG_SOFT_TIMEOUT</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">(</span>
                <span class="s2">"Soft timeouts are not supported: "</span>
                <span class="s2">"on this platform: It does not have the SIGUSR1 signal."</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="n">soft_timeout</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span><span class="p">:</span>
            <span class="n">waitforslot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">putlocks</span> <span class="k">if</span> <span class="n">waitforslot</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">waitforslot</span>
            <span class="k">if</span> <span class="n">waitforslot</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_putlock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_putlock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ApplyResult</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">accept_callback</span><span class="p">,</span> <span class="n">timeout_callback</span><span class="p">,</span>
                <span class="n">error_callback</span><span class="p">,</span> <span class="n">soft_timeout</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">lost_worker_timeout</span><span class="p">,</span>
                <span class="n">on_timeout_set</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_timeout_set</span><span class="p">,</span>
                <span class="n">on_timeout_cancel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_timeout_cancel</span><span class="p">,</span>
                <span class="n">callbacks_propagate</span><span class="o">=</span><span class="n">callbacks_propagate</span><span class="p">,</span>
                <span class="n">send_ack</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">send_ack</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synack</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                <span class="n">correlation_id</span><span class="o">=</span><span class="n">correlation_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="n">soft_timeout</span><span class="p">:</span>
                <span class="c1"># start the timeout handler thread when required.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_start_timeout_handler</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_taskqueue</span><span class="o">.</span><span class="n">put</span><span class="p">(([(</span><span class="n">TASK</span><span class="p">,</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                    <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">))],</span> <span class="bp">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_quick_put</span><span class="p">((</span><span class="n">TASK</span><span class="p">,</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">send_ack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">terminate_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">proc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_by_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">sig</span> <span class="ow">or</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">get_errno</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ESRCH</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">_controlled_termination</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">_job_terminated</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">map_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">error_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">'''</span>
<span class="sd">        Asynchronous equivalent of `map()` method.</span>
<span class="sd">        '''</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_async</span><span class="p">(</span>
            <span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">mapstar</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">error_callback</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_map_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">error_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">'''</span>
<span class="sd">        Helper function to implement map, starmap and their async counterparts.</span>
<span class="sd">        '''</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">RUN</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="s1">'__len__'</span><span class="p">):</span>
            <span class="n">iterable</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">chunksize</span><span class="p">,</span> <span class="n">extra</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
                <span class="n">chunksize</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">chunksize</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">task_batches</span> <span class="o">=</span> <span class="n">Pool</span><span class="o">.</span><span class="n">_get_tasks</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">MapResult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">),</span> <span class="n">callback</span><span class="p">,</span>
                           <span class="n">error_callback</span><span class="o">=</span><span class="n">error_callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_taskqueue</span><span class="o">.</span><span class="n">put</span><span class="p">((((</span><span class="n">TASK</span><span class="p">,</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,),</span> <span class="p">{}))</span>
                              <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">task_batches</span><span class="p">)),</span> <span class="bp">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_tasks</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">'pool objects cannot be passed between processes or pickled'</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'closing pool'</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">RUN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">CLOSE</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_putlock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_putlock</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker_handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_taskqueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">stop_if_not_current</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_handler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'terminating pool'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">TERMINATE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_handler</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_terminate</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_stop_task_handler</span><span class="p">(</span><span class="n">task_handler</span><span class="p">):</span>
        <span class="n">stop_if_not_current</span><span class="p">(</span><span class="n">task_handler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">in</span> <span class="p">(</span><span class="n">CLOSE</span><span class="p">,</span> <span class="n">TERMINATE</span><span class="p">)</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'joining worker handler'</span><span class="p">)</span>
        <span class="n">stop_if_not_current</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_handler</span><span class="p">)</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'joining task handler'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_task_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_handler</span><span class="p">)</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'joining result handler'</span><span class="p">)</span>
        <span class="n">stop_if_not_current</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result_handler</span><span class="p">)</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'result handler joined'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">):</span>
            <span class="n">debug</span><span class="p">(</span><span class="s1">'joining worker </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%r</span><span class="s1">)'</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">_popen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1"># process started?</span>
                <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'pool join complete'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_poolctrl</span><span class="p">):</span>
            <span class="n">e</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_help_stuff_finish</span><span class="p">(</span><span class="n">inqueue</span><span class="p">,</span> <span class="n">task_handler</span><span class="p">,</span> <span class="n">_pool</span><span class="p">):</span>
        <span class="c1"># task_handler may be blocked trying to put items on inqueue</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'removing tasks from inqueue until task handler finished'</span><span class="p">)</span>
        <span class="n">inqueue</span><span class="o">.</span><span class="n">_rlock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">task_handler</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="ow">and</span> <span class="n">inqueue</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">poll</span><span class="p">():</span>
            <span class="n">inqueue</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_set_result_sentinel</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">outqueue</span><span class="p">,</span> <span class="n">pool</span><span class="p">):</span>
        <span class="n">outqueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_terminate_pool</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">taskqueue</span><span class="p">,</span> <span class="n">inqueue</span><span class="p">,</span> <span class="n">outqueue</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span>
                        <span class="n">worker_handler</span><span class="p">,</span> <span class="n">task_handler</span><span class="p">,</span>
                        <span class="n">result_handler</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">,</span>
                        <span class="n">help_stuff_finish_args</span><span class="p">):</span>

        <span class="c1"># this is guaranteed to only be called once</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">'finalizing pool'</span><span class="p">)</span>

        <span class="n">worker_handler</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

        <span class="n">task_handler</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">taskqueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>                 <span class="c1"># sentinel</span>

        <span class="n">debug</span><span class="p">(</span><span class="s1">'helping task handler/workers to finish'</span><span class="p">)</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">_help_stuff_finish</span><span class="p">(</span><span class="o">*</span><span class="n">help_stuff_finish_args</span><span class="p">)</span>

        <span class="n">result_handler</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">_set_result_sentinel</span><span class="p">(</span><span class="n">outqueue</span><span class="p">,</span> <span class="n">pool</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">timeout_handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">timeout_handler</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

        <span class="c1"># Terminate workers which haven't already finished</span>
        <span class="k">if</span> <span class="n">pool</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pool</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">'terminate'</span><span class="p">):</span>
            <span class="n">debug</span><span class="p">(</span><span class="s1">'terminating workers'</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">_is_alive</span><span class="p">():</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

        <span class="n">debug</span><span class="p">(</span><span class="s1">'joining task handler'</span><span class="p">)</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">_stop_task_handler</span><span class="p">(</span><span class="n">task_handler</span><span class="p">)</span>

        <span class="n">debug</span><span class="p">(</span><span class="s1">'joining result handler'</span><span class="p">)</span>
        <span class="n">result_handler</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">timeout_handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">debug</span><span class="p">(</span><span class="s1">'joining timeout handler'</span><span class="p">)</span>
            <span class="n">timeout_handler</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">TIMEOUT_MAX</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pool</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pool</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">'terminate'</span><span class="p">):</span>
            <span class="n">debug</span><span class="p">(</span><span class="s1">'joining pool workers'</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="c1"># worker has not yet exited</span>
                    <span class="n">debug</span><span class="p">(</span><span class="s1">'cleaning up worker </span><span class="si">%d</span><span class="s1">'</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">_popen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">debug</span><span class="p">(</span><span class="s1">'pool workers joined'</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">process_sentinels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">_popen</span><span class="o">.</span><span class="n">sentinel</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">]</span>

<span class="c1">#</span>
<span class="c1"># Class whose instances are returned by `Pool.apply_async()`</span>
<span class="c1">#</span>


<span class="k">class</span> <span class="nc">ApplyResult</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">_worker_lost</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_write_to</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_scheduled_for</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">accept_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">timeout_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">error_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">soft_timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lost_worker_timeout</span><span class="o">=</span><span class="n">LOST_WORKER_TIMEOUT</span><span class="p">,</span>
                 <span class="n">on_timeout_set</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">on_timeout_cancel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">callbacks_propagate</span><span class="o">=</span><span class="p">(),</span> <span class="n">send_ack</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">correlation_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correlation_id</span> <span class="o">=</span> <span class="n">correlation_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mutex</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_job</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">job_counter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accept_callback</span> <span class="o">=</span> <span class="n">accept_callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error_callback</span> <span class="o">=</span> <span class="n">error_callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_callback</span> <span class="o">=</span> <span class="n">timeout_callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_soft_timeout</span> <span class="o">=</span> <span class="n">soft_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lost_worker_timeout</span> <span class="o">=</span> <span class="n">lost_worker_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_timeout_set</span> <span class="o">=</span> <span class="n">on_timeout_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_timeout_cancel</span> <span class="o">=</span> <span class="n">on_timeout_cancel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks_propagate</span> <span class="o">=</span> <span class="n">callbacks_propagate</span> <span class="ow">or</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_ack</span> <span class="o">=</span> <span class="n">send_ack</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_accepted</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cancelled</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_pid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_accepted</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">'&lt;Result: {id} ack:{ack} ready:{ready}&gt;'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="n">ack</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_accepted</span><span class="p">,</span> <span class="n">ready</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ready</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">isSet</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">accepted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accepted</span>

    <span class="k">def</span> <span class="nf">successful</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_success</span>

    <span class="k">def</span> <span class="nf">_cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Only works if synack is used."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cancelled</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span> <span class="o">=</span> <span class="n">signum</span>

    <span class="k">def</span> <span class="nf">_set_terminated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Terminated</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">signum</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">Terminated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">ExceptionInfo</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">worker_pids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_pid</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_pid</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">TimeoutError</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_success</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="o">.</span><span class="n">exception</span>

    <span class="k">def</span> <span class="nf">safe_apply_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fun</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks_propagate</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">'Pool callback raised exception: </span><span class="si">%r</span><span class="s1">'</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span>
                      <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soft</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">safe_apply_callback</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_callback</span><span class="p">,</span> <span class="n">soft</span><span class="o">=</span><span class="n">soft</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_soft_timeout</span> <span class="k">if</span> <span class="n">soft</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mutex</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_timeout_cancel</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_timeout_cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_success</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accepted</span><span class="p">:</span>
                <span class="c1"># if not accepted yet, then the set message</span>
                <span class="c1"># was received before the ack, which means</span>
                <span class="c1"># the ack will remove the entry.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

            <span class="c1"># apply callbacks last</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">safe_apply_callback</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_error_callback</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_success</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">safe_apply_callback</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_error_callback</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">time_accepted</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">synqW_fd</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mutex</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cancelled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_ack</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_accepted</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">synqW_fd</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_ack</span><span class="p">(</span><span class="n">NACK</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="n">synqW_fd</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accepted</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time_accepted</span> <span class="o">=</span> <span class="n">time_accepted</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker_pid</span> <span class="o">=</span> <span class="n">pid</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
                <span class="c1"># ack received after set()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_timeout_set</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_timeout_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_soft_timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">ACK</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accept_callback</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_accept_callback</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">time_accepted</span><span class="p">)</span>
                <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_errors</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">NACK</span>
                    <span class="k">raise</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">NACK</span>
                    <span class="c1"># ignore other errors</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_ack</span> <span class="ow">and</span> <span class="n">synqW_fd</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_ack</span><span class="p">(</span>
                            <span class="n">response</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="n">synqW_fd</span>
                        <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_ack</span> <span class="ow">and</span> <span class="n">synqW_fd</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_send_ack</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="n">synqW_fd</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># Class whose instances are returned by `Pool.map_async()`</span>
<span class="c1">#</span>


<span class="k">class</span> <span class="nc">MapResult</span><span class="p">(</span><span class="n">ApplyResult</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">error_callback</span><span class="p">):</span>
        <span class="n">ApplyResult</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">error_callback</span><span class="o">=</span><span class="n">error_callback</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_success</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="n">length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accepted</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_pid</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_accepted</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunksize</span> <span class="o">=</span> <span class="n">chunksize</span>
        <span class="k">if</span> <span class="n">chunksize</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_number_left</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_number_left</span> <span class="o">=</span> <span class="n">length</span> <span class="o">//</span> <span class="n">chunksize</span> <span class="o">+</span> <span class="nb">bool</span><span class="p">(</span><span class="n">length</span> <span class="o">%</span> <span class="n">chunksize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">success_result</span><span class="p">):</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">success_result</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunksize</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunksize</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_number_left</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_number_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accepted</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_success</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_callback</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accepted</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_ack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">time_accepted</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunksize</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunksize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accepted</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker_pid</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time_accepted</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_accepted</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">accepted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accepted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">worker_pids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">pid</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_pid</span> <span class="k">if</span> <span class="n">pid</span><span class="p">]</span>

<span class="c1">#</span>
<span class="c1"># Class whose instances are returned by `Pool.imap()`</span>
<span class="c1">#</span>


<span class="k">class</span> <span class="nc">IMapIterator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">_worker_lost</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">lost_worker_timeout</span><span class="o">=</span><span class="n">LOST_WORKER_TIMEOUT</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Condition</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_job</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">job_counter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unsorted</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_pids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lost_worker_timeout</span> <span class="o">=</span> <span class="n">lost_worker_timeout</span>
        <span class="n">cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">raise</span> <span class="ne">StopIteration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">raise</span> <span class="ne">StopIteration</span>
                    <span class="k">raise</span> <span class="n">TimeoutError</span>

        <span class="n">success</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">__next__</span> <span class="o">=</span> <span class="nb">next</span>                    <span class="c1"># XXX</span>

    <span class="k">def</span> <span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unsorted</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unsorted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_unsorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_set_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="n">length</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_ack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">time_accepted</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span>

    <span class="k">def</span> <span class="nf">worker_pids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_pids</span>

<span class="c1">#</span>
<span class="c1"># Class whose instances are returned by `Pool.imap_unordered()`</span>
<span class="c1">#</span>


<span class="k">class</span> <span class="nc">IMapUnorderedIterator</span><span class="p">(</span><span class="n">IMapIterator</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">]</span>

<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>


<span class="k">class</span> <span class="nc">ThreadPool</span><span class="p">(</span><span class="n">Pool</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">billiard.dummy</span> <span class="kn">import</span> <span class="n">Process</span> <span class="k">as</span> <span class="n">DummyProcess</span>
    <span class="n">Process</span> <span class="o">=</span> <span class="n">DummyProcess</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="p">()):</span>
        <span class="n">Pool</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processes</span><span class="p">,</span> <span class="n">initializer</span><span class="p">,</span> <span class="n">initargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inqueue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outqueue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quick_put</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inqueue</span><span class="o">.</span><span class="n">put</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quick_get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outqueue</span><span class="o">.</span><span class="n">get</span>

        <span class="k">def</span> <span class="nf">_poll_result</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quick_get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_poll_result</span> <span class="o">=</span> <span class="n">_poll_result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_help_stuff_finish</span><span class="p">(</span><span class="n">inqueue</span><span class="p">,</span> <span class="n">task_handler</span><span class="p">,</span> <span class="n">pool</span><span class="p">):</span>
        <span class="c1"># put sentinels at head of inqueue to make workers finish</span>
        <span class="k">with</span> <span class="n">inqueue</span><span class="o">.</span><span class="n">not_empty</span><span class="p">:</span>
            <span class="n">inqueue</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">inqueue</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="p">))</span>
            <span class="n">inqueue</span><span class="o">.</span><span class="n">not_empty</span><span class="o">.</span><span class="n">notify_all</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>

<div class="clearer"></div>
</div>

<div class="footer" role="contentinfo">
        Â© <a href="../../copyright.html">Copyright</a> 2009-2015, Ask Solem &amp; Contributors.
    </div>
</body>
</html>