<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Extensions and Bootsteps — Celery 3.1.23 documentation</title>
<link href="../_static/celery.css" rel="stylesheet" type="text/css"/>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.1.23',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
<script src="../_static/jquery.js" type="text/javascript"></script>
<script src="../_static/underscore.js" type="text/javascript"></script>
<script src="../_static/doctools.js" type="text/javascript"></script>
<link href="../copyright.html" rel="copyright" title="Copyright"/>
<link href="../index.html" rel="top" title="Celery 3.1.23 documentation"/>
<link href="index.html" rel="up" title="User Guide"/>
<link href="../configuration.html" rel="next" title="Configuration and defaults"/>
<link href="signals.html" rel="prev" title="Signals"/>
</head>
<body role="document">

<div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<div class="deck">
<p>
        This document describes the current stable version of Celery (3.1). For development docs,
        <a href="http://docs.celeryproject.org/en/master/userguide/extending.html">go here</a>.
        </p>
</div>
<div class="section" id="extensions-and-bootsteps">
<span id="guide-extending"></span><h1>Extensions and Bootsteps<a class="headerlink" href="#extensions-and-bootsteps" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#custom-message-consumers" id="id4">Custom Message Consumers</a></li>
<li><a class="reference internal" href="#blueprints" id="id5">Blueprints</a></li>
<li><a class="reference internal" href="#worker" id="id6">Worker</a><ul>
<li><a class="reference internal" href="#attributes" id="id7">Attributes</a></li>
<li><a class="reference internal" href="#example-worker-bootstep" id="id8">Example worker bootstep</a></li>
</ul>
</li>
<li><a class="reference internal" href="#consumer" id="id9">Consumer</a><ul>
<li><a class="reference internal" href="#extending-consumer-attributes" id="id10">Attributes</a></li>
<li><a class="reference internal" href="#methods" id="id11">Methods</a></li>
</ul>
</li>
<li><a class="reference internal" href="#installing-bootsteps" id="id12">Installing Bootsteps</a></li>
<li><a class="reference internal" href="#command-line-programs" id="id13">Command-line programs</a><ul>
<li><a class="reference internal" href="#adding-new-command-line-options" id="id14">Adding new command-line options</a></li>
<li><a class="reference internal" href="#adding-new-celery-sub-commands" id="id15">Adding new <strong class="program">celery</strong> sub-commands</a></li>
</ul>
</li>
<li><a class="reference internal" href="#worker-api" id="id16">Worker API</a><ul>
<li><a class="reference internal" href="#hub-the-workers-async-event-loop" id="id17"></a><a class="reference external" href="http://kombu.readthedocs.org/en/latest/reference/kombu.async.html#kombu.async.Hub" title="(in Kombu v3.0)"><code class="xref py py-class docutils literal"><span class="pre">Hub</span></code></a> - The workers async event loop.</li>
<li><a class="reference internal" href="#timer-scheduling-events" id="id18">Timer - Scheduling events</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="custom-message-consumers">
<span id="extending-custom-consumers"></span><h2><a class="toc-backref" href="#id4">Custom Message Consumers</a><a class="headerlink" href="#custom-message-consumers" title="Permalink to this headline">¶</a></h2>
<p>You may want to embed custom Kombu consumers to manually process your messages.</p>
<p>For that purpose a special <code class="xref py py-class docutils literal"><span class="pre">ConsumerStep</span></code> bootstep class
exists, where you only need to define the <code class="docutils literal"><span class="pre">get_consumers</span></code> method, which must
return a list of <a class="reference external" href="http://kombu.readthedocs.org/en/latest/reference/kombu.html#kombu.Consumer" title="(in Kombu v3.0)"><code class="xref py py-class docutils literal"><span class="pre">kombu.Consumer</span></code></a> objects to start
whenever the connection is established:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">bootsteps</span>
<span class="kn">from</span> <span class="nn">kombu</span> <span class="kn">import</span> <span class="n">Consumer</span><span class="p">,</span> <span class="n">Exchange</span><span class="p">,</span> <span class="n">Queue</span>

<span class="n">my_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="s1">'custom'</span><span class="p">,</span> <span class="n">Exchange</span><span class="p">(</span><span class="s1">'custom'</span><span class="p">),</span> <span class="s1">'routing_key'</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s1">'amqp://'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MyConsumerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">ConsumerStep</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_consumers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Consumer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span>
                         <span class="n">queues</span><span class="o">=</span><span class="p">[</span><span class="n">my_queue</span><span class="p">],</span>
                         <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_message</span><span class="p">],</span>
                         <span class="n">accept</span><span class="o">=</span><span class="p">[</span><span class="s1">'json'</span><span class="p">])]</span>

    <span class="k">def</span> <span class="nf">handle_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Received message: {0!r}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
        <span class="n">message</span><span class="o">.</span><span class="n">ack</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">'consumer'</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyConsumerStep</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">send_me_a_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="s1">'world!'</span><span class="p">,</span> <span class="n">producer</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">producer_or_acquire</span><span class="p">(</span><span class="n">producer</span><span class="p">)</span> <span class="k">as</span> <span class="n">producer</span><span class="p">:</span>
        <span class="n">producer</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">'hello'</span><span class="p">:</span> <span class="n">who</span><span class="p">},</span>
            <span class="n">serializer</span><span class="o">=</span><span class="s1">'json'</span><span class="p">,</span>
            <span class="n">exchange</span><span class="o">=</span><span class="n">my_queue</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span>
            <span class="n">routing_key</span><span class="o">=</span><span class="s1">'routing_key'</span><span class="p">,</span>
            <span class="n">declare</span><span class="o">=</span><span class="p">[</span><span class="n">my_queue</span><span class="p">],</span>
            <span class="n">retry</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">send_me_a_message</span><span class="p">(</span><span class="s1">'celery'</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Kombu Consumers can take use of two different message callback dispatching
mechanisms.  The first one is the <code class="docutils literal"><span class="pre">callbacks</span></code> argument which accepts
a list of callbacks with a <code class="docutils literal"><span class="pre">(body,</span> <span class="pre">message)</span></code> signature,
the second one is the <code class="docutils literal"><span class="pre">on_message</span></code> argument which takes a single
callback with a <code class="docutils literal"><span class="pre">(message,</span> <span class="pre">)</span></code> signature.  The latter will not
automatically decode and deserialize the payload which is useful
in many cases:</p>
<div class="last highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_consumers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Consumer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">queues</span><span class="o">=</span><span class="p">[</span><span class="n">my_queue</span><span class="p">],</span>
                     <span class="n">on_message</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_message</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span>
        <span class="s1">'Received message: {0!r} {props!r} rawlen={s}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">payload</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="p">),</span>
    <span class="p">))</span>
    <span class="n">message</span><span class="o">.</span><span class="n">ack</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="blueprints">
<span id="extending-blueprints"></span><h2><a class="toc-backref" href="#id5">Blueprints</a><a class="headerlink" href="#blueprints" title="Permalink to this headline">¶</a></h2>
<p>Bootsteps is a technique to add functionality to the workers.
A bootstep is a custom class that defines hooks to do custom actions
at different stages in the worker.   Every bootstep belongs to a blueprint,
and the worker currently defines two blueprints: <strong>Worker</strong>, and <strong>Consumer</strong></p>
<hr class="docutils"/>
<dl class="docutils">
<dt><strong>Figure A:</strong> Bootsteps in the Worker and Consumer blueprints.  Starting</dt>
<dd>from the bottom up the first step in the worker blueprint
is the Timer, and the last step is to start the Consumer blueprint,
which then establishes the broker connection and starts
consuming messages.</dd>
</dl>
<div class="figure">
<img alt="../_images/worker_graph_full.png" src="../_images/worker_graph_full.png"/>
</div>
<hr class="docutils"/>
</div>
<div class="section" id="worker">
<span id="extending-worker-blueprint"></span><h2><a class="toc-backref" href="#id6">Worker</a><a class="headerlink" href="#worker" title="Permalink to this headline">¶</a></h2>
<p>The Worker is the first blueprint to start, and with it starts major components like
the event loop, processing pool, the timer, and also optional components
like the autoscaler.  When the worker is fully started it will continue
to the Consumer blueprint.</p>
<p>The <a class="reference internal" href="../reference/celery.worker.html#celery.worker.WorkController" title="celery.worker.WorkController"><code class="xref py py-class docutils literal"><span class="pre">WorkController</span></code></a> is the core worker implementation,
and contains several methods and attributes that you can use in your bootstep.</p>
<div class="section" id="attributes">
<span id="extending-worker-blueprint-attributes"></span><h3><a class="toc-backref" href="#id7">Attributes</a><a class="headerlink" href="#attributes" title="Permalink to this headline">¶</a></h3>
<span class="target" id="extending-worker-app"></span><dl class="attribute">
<dt id="app"><a name="//apple_ref/cpp/Attribute/app"></a>
<code class="descname">app</code><a class="headerlink" href="#app" title="Permalink to this definition">¶</a></dt>
<dd><p>The current app instance.</p>
</dd></dl>
<span class="target" id="extending-worker-hostname"></span><dl class="attribute">
<dt id="hostname"><a name="//apple_ref/cpp/Attribute/hostname"></a>
<code class="descname">hostname</code><a class="headerlink" href="#hostname" title="Permalink to this definition">¶</a></dt>
<dd><p>The workers node name (e.g. <cite>worker1@example.com</cite>)</p>
</dd></dl>
<span class="target" id="id1"></span><dl class="attribute">
<dt id="blueprint"><a name="//apple_ref/cpp/Attribute/blueprint"></a>
<code class="descname">blueprint</code><a class="headerlink" href="#blueprint" title="Permalink to this definition">¶</a></dt>
<dd><p>This is the worker <a class="reference internal" href="../reference/celery.bootsteps.html#celery.bootsteps.Blueprint" title="celery.bootsteps.Blueprint"><code class="xref py py-class docutils literal"><span class="pre">Blueprint</span></code></a>.</p>
</dd></dl>
<span class="target" id="extending-worker-hub"></span><dl class="attribute">
<dt id="hub"><a name="//apple_ref/cpp/Attribute/hub"></a>
<code class="descname">hub</code><a class="headerlink" href="#hub" title="Permalink to this definition">¶</a></dt>
<dd><p>Event loop object (<a class="reference external" href="http://kombu.readthedocs.org/en/latest/reference/kombu.async.html#kombu.async.Hub" title="(in Kombu v3.0)"><code class="xref py py-class docutils literal"><span class="pre">Hub</span></code></a>).  You can use
this to register callbacks in the event loop.</p>
<p>This is only supported by async I/O enabled transports (amqp, redis),
in which case the <cite>worker.use_eventloop</cite> attribute should be set.</p>
<p>Your worker bootstep must require the Hub bootstep to use this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'celery.worker.components:Hub'</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</dd></dl>
<span class="target" id="extending-worker-pool"></span><dl class="attribute">
<dt id="pool"><a name="//apple_ref/cpp/Attribute/pool"></a>
<code class="descname">pool</code><a class="headerlink" href="#pool" title="Permalink to this definition">¶</a></dt>
<dd><p>The current process/eventlet/gevent/thread pool.
See <a class="reference internal" href="../internals/reference/celery.concurrency.base.html#celery.concurrency.base.BasePool" title="celery.concurrency.base.BasePool"><code class="xref py py-class docutils literal"><span class="pre">celery.concurrency.base.BasePool</span></code></a>.</p>
<p>Your worker bootstep must require the Pool bootstep to use this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'celery.worker.components:Pool'</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</dd></dl>
<span class="target" id="extending-worker-timer"></span><dl class="attribute">
<dt id="timer"><a name="//apple_ref/cpp/Attribute/timer"></a>
<code class="descname">timer</code><a class="headerlink" href="#timer" title="Permalink to this definition">¶</a></dt>
<dd><p><a class="reference external" href="http://kombu.readthedocs.org/en/latest/reference/kombu.async.timer.html#kombu.async.timer.Timer" title="(in Kombu v3.0)"><code class="xref py py-class docutils literal"><span class="pre">Timer</span></code></a> used to schedule functions.</p>
<p>Your worker bootstep must require the Timer bootstep to use this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'celery.worker.components:Timer'</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</dd></dl>
<span class="target" id="extending-worker-statedb"></span><dl class="attribute">
<dt id="statedb"><a name="//apple_ref/cpp/Attribute/statedb"></a>
<code class="descname">statedb</code><a class="headerlink" href="#statedb" title="Permalink to this definition">¶</a></dt>
<dd><p><code class="xref py py-class docutils literal"><span class="pre">Database</span> <span class="pre">&lt;celery.worker.state.Persistent&gt;`</span></code> to persist state between
worker restarts.</p>
<p>This is only defined if the <code class="docutils literal"><span class="pre">statedb</span></code> argument is enabled.</p>
<p>Your worker bootstep must require the Statedb bootstep to use this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'celery.worker.components:Statedb'</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</dd></dl>
<span class="target" id="extending-worker-autoscaler"></span><dl class="attribute">
<dt id="autoscaler"><a name="//apple_ref/cpp/Attribute/autoscaler"></a>
<code class="descname">autoscaler</code><a class="headerlink" href="#autoscaler" title="Permalink to this definition">¶</a></dt>
<dd><p><code class="xref py py-class docutils literal"><span class="pre">Autoscaler</span></code> used to automatically grow
and shrink the number of processes in the pool.</p>
<p>This is only defined if the <code class="docutils literal"><span class="pre">autoscale</span></code> argument is enabled.</p>
<p>Your worker bootstep must require the <cite>Autoscaler</cite> bootstep to use this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'celery.worker.autoscaler:Autoscaler'</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</dd></dl>
<span class="target" id="extending-worker-autoreloader"></span><dl class="attribute">
<dt id="autoreloader"><a name="//apple_ref/cpp/Attribute/autoreloader"></a>
<code class="descname">autoreloader</code><a class="headerlink" href="#autoreloader" title="Permalink to this definition">¶</a></dt>
<dd><p><code class="xref py py-class docutils literal"><span class="pre">Autoreloader</span></code> used to automatically
reload use code when the filesystem changes.</p>
<p>This is only defined if the <code class="docutils literal"><span class="pre">autoreload</span></code> argument is enabled.
Your worker bootstep must require the <cite>Autoreloader</cite> bootstep to use this;</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'celery.worker.autoreloader:Autoreloader'</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</dd></dl>
</div>
<div class="section" id="example-worker-bootstep">
<h3><a class="toc-backref" href="#id8">Example worker bootstep</a><a class="headerlink" href="#example-worker-bootstep" title="Permalink to this headline">¶</a></h3>
<p>An example Worker bootstep could be:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">bootsteps</span>

<span class="k">class</span> <span class="nc">ExampleWorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'Pool'</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Called when the WorkController instance is constructed'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Arguments to WorkController: {0!r}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="c1"># this method can be used to delegate the action methods</span>
        <span class="c1"># to another object that implements ``start`` and ``stop``.</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Called when the worker is started.'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Called when the worker shuts down."</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Called when the worker terminates"</span><span class="p">)</span>
</pre></div>
</div>
<p>Every method is passed the current <code class="docutils literal"><span class="pre">WorkController</span></code> instance as the first
argument.</p>
<p>Another example could use the timer to wake up at regular intervals:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">bootsteps</span>


<span class="k">class</span> <span class="nc">DeadlockDetection</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'Timer'</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">deadlock_timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">deadlock_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tref</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="c1"># run every 30 seconds.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tref</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">call_repeatedly</span><span class="p">(</span>
            <span class="mf">30.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect</span><span class="p">,</span> <span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="p">),</span> <span class="n">priority</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tref</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tref</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tref</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">detect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="c1"># update active requests</span>
        <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">active_requests</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">time_start</span> <span class="ow">and</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">req</span><span class="o">.</span><span class="n">time_start</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="consumer">
<span id="extending-consumer-blueprint"></span><h2><a class="toc-backref" href="#id9">Consumer</a><a class="headerlink" href="#consumer" title="Permalink to this headline">¶</a></h2>
<p>The Consumer blueprint establishes a connection to the broker, and
is restarted every time this connection is lost.   Consumer bootsteps
include the worker heartbeat, the remote control command consumer, and
importantly, the task consumer.</p>
<p>When you create consumer bootsteps you must take into account that it must
be possible to restart your blueprint.  An additional ‘shutdown’ method is
defined for consumer bootsteps, this method is called when the worker is
shutdown.</p>
<div class="section" id="extending-consumer-attributes">
<span id="id2"></span><h3><a class="toc-backref" href="#id10">Attributes</a><a class="headerlink" href="#extending-consumer-attributes" title="Permalink to this headline">¶</a></h3>
<span class="target" id="extending-consumer-app"></span><dl class="attribute">
<dt>
<code class="descname">app</code></dt>
<dd><p>The current app instance.</p>
</dd></dl>
<span class="target" id="extending-consumer-controller"></span><dl class="attribute">
<dt id="controller"><a name="//apple_ref/cpp/Attribute/controller"></a>
<code class="descname">controller</code><a class="headerlink" href="#controller" title="Permalink to this definition">¶</a></dt>
<dd><p>The parent <a class="reference internal" href="../reference/celery.worker.html#celery.worker.WorkController" title="celery.worker.WorkController"><code class="xref py py-class docutils literal"><span class="pre">WorkController</span></code></a> object that created this consumer.</p>
</dd></dl>
<span class="target" id="extending-consumer-hostname"></span><dl class="attribute">
<dt>
<code class="descname">hostname</code></dt>
<dd><p>The workers node name (e.g. <cite>worker1@example.com</cite>)</p>
</dd></dl>
<span class="target" id="id3"></span><dl class="attribute">
<dt>
<code class="descname">blueprint</code></dt>
<dd><p>This is the worker <a class="reference internal" href="../reference/celery.bootsteps.html#celery.bootsteps.Blueprint" title="celery.bootsteps.Blueprint"><code class="xref py py-class docutils literal"><span class="pre">Blueprint</span></code></a>.</p>
</dd></dl>
<span class="target" id="extending-consumer-hub"></span><dl class="attribute">
<dt>
<code class="descname">hub</code></dt>
<dd><p>Event loop object (<a class="reference external" href="http://kombu.readthedocs.org/en/latest/reference/kombu.async.html#kombu.async.Hub" title="(in Kombu v3.0)"><code class="xref py py-class docutils literal"><span class="pre">Hub</span></code></a>).  You can use
this to register callbacks in the event loop.</p>
<p>This is only supported by async I/O enabled transports (amqp, redis),
in which case the <cite>worker.use_eventloop</cite> attribute should be set.</p>
<p>Your worker bootstep must require the Hub bootstep to use this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'celery.worker:Hub'</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</dd></dl>
<span class="target" id="extending-consumer-connection"></span><dl class="attribute">
<dt id="connection"><a name="//apple_ref/cpp/Attribute/connection"></a>
<code class="descname">connection</code><a class="headerlink" href="#connection" title="Permalink to this definition">¶</a></dt>
<dd><p>The current broker connection (<a class="reference external" href="http://kombu.readthedocs.org/en/latest/reference/kombu.html#kombu.Connection" title="(in Kombu v3.0)"><code class="xref py py-class docutils literal"><span class="pre">kombu.Connection</span></code></a>).</p>
<p>A consumer bootstep must require the ‘Connection’ bootstep
to use this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'celery.worker.consumer:Connection'</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</dd></dl>
<span class="target" id="extending-consumer-event-dispatcher"></span><dl class="attribute">
<dt id="event_dispatcher"><a name="//apple_ref/cpp/Attribute/event_dispatcher"></a>
<code class="descname">event_dispatcher</code><a class="headerlink" href="#event_dispatcher" title="Permalink to this definition">¶</a></dt>
<dd><p>A <a class="reference internal" href="../reference/celery.events.html#celery.events.Events.Dispatcher" title="celery.events.Events.Dispatcher"><code class="xref py py-class docutils literal"><span class="pre">app.events.Dispatcher</span></code></a> object that can be used to send events.</p>
<p>A consumer bootstep must require the <cite>Events</cite> bootstep to use this.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'celery.worker.consumer:Events'</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</dd></dl>
<span class="target" id="extending-consumer-gossip"></span><dl class="attribute">
<dt id="gossip"><a name="//apple_ref/cpp/Attribute/gossip"></a>
<code class="descname">gossip</code><a class="headerlink" href="#gossip" title="Permalink to this definition">¶</a></dt>
<dd><p>Worker to worker broadcast communication
(<a class="reference internal" href="../reference/celery.worker.consumer.html#celery.worker.consumer.Gossip" title="celery.worker.consumer.Gossip"><code class="xref py py-class docutils literal"><span class="pre">Gossip</span></code></a>).</p>
<p>A consumer bootstep must require the <cite>Gossip</cite> bootstep to use this.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RatelimitStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="sd">"""Rate limit tasks based on the number of workers in the</span>
<span class="sd">    cluster."""</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'celery.worker.consumer:Gossip'</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gossip</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">node_join</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_cluster_size_change</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gossip</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">node_leave</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_cluster_size_change</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gossip</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">node_lost</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_node_lost</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="s1">'proj.tasks.add'</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="s1">'proj.tasks.mul'</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_size</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">on_cluster_size_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="n">cluster_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gossip</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">alive_workers</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">cluster_size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_size</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">rate_limit</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">cluster_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">reset_rate_limits</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_size</span> <span class="o">=</span> <span class="n">cluster_size</span>

    <span class="k">def</span> <span class="nf">on_node_lost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="c1"># may have processed heartbeat too late, so wake up soon</span>
        <span class="c1"># in order to see if the worker recovered.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">call_after</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_cluster_size_change</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Callbacks</strong></p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">&lt;set&gt;</span> <span class="pre">gossip.on.node_join</span></code></p>
<blockquote>
<div><p>Called whenever a new node joins the cluster, providing a
<a class="reference internal" href="../reference/celery.events.state.html#celery.events.state.Worker" title="celery.events.state.Worker"><code class="xref py py-class docutils literal"><span class="pre">Worker</span></code></a> instance.</p>
</div></blockquote>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">&lt;set&gt;</span> <span class="pre">gossip.on.node_leave</span></code></p>
<blockquote>
<div><p>Called whenever a new node leaves the cluster (shuts down),
providing a <a class="reference internal" href="../reference/celery.events.state.html#celery.events.state.Worker" title="celery.events.state.Worker"><code class="xref py py-class docutils literal"><span class="pre">Worker</span></code></a> instance.</p>
</div></blockquote>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">&lt;set&gt;</span> <span class="pre">gossip.on.node_lost</span></code></p>
<blockquote>
<div><p>Called whenever heartbeat was missed for a worker instance in the
cluster (heartbeat not received or processed in time),
providing a <a class="reference internal" href="../reference/celery.events.state.html#celery.events.state.Worker" title="celery.events.state.Worker"><code class="xref py py-class docutils literal"><span class="pre">Worker</span></code></a> instance.</p>
<p>This does not necessarily mean the worker is actually offline, so use a time
out mechanism if the default heartbeat timeout is not sufficient.</p>
</div></blockquote>
</li>
</ul>
</dd></dl>
<span class="target" id="extending-consumer-pool"></span><dl class="attribute">
<dt>
<code class="descname">pool</code></dt>
<dd><p>The current process/eventlet/gevent/thread pool.
See <a class="reference internal" href="../internals/reference/celery.concurrency.base.html#celery.concurrency.base.BasePool" title="celery.concurrency.base.BasePool"><code class="xref py py-class docutils literal"><span class="pre">celery.concurrency.base.BasePool</span></code></a>.</p>
</dd></dl>
<span class="target" id="extending-consumer-timer"></span><dl class="attribute">
<dt>
<code class="descname">timer</code></dt>
<dd><p><code class="xref py py-class docutils literal"><span class="pre">Timer</span> <span class="pre">&lt;celery.utils.timer2.Schedule</span></code> used to schedule functions.</p>
</dd></dl>
<span class="target" id="extending-consumer-heart"></span><dl class="attribute">
<dt id="heart"><a name="//apple_ref/cpp/Attribute/heart"></a>
<code class="descname">heart</code><a class="headerlink" href="#heart" title="Permalink to this definition">¶</a></dt>
<dd><p>Responsible for sending worker event heartbeats
(<a class="reference internal" href="../internals/reference/celery.worker.heartbeat.html#celery.worker.heartbeat.Heart" title="celery.worker.heartbeat.Heart"><code class="xref py py-class docutils literal"><span class="pre">Heart</span></code></a>).</p>
<p>Your consumer bootstep must require the <cite>Heart</cite> bootstep to use this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'celery.worker.consumer:Heart'</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</dd></dl>
<span class="target" id="extending-consumer-task-consumer"></span><dl class="attribute">
<dt id="task_consumer"><a name="//apple_ref/cpp/Attribute/task_consumer"></a>
<code class="descname">task_consumer</code><a class="headerlink" href="#task_consumer" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference external" href="http://kombu.readthedocs.org/en/latest/reference/kombu.html#kombu.Consumer" title="(in Kombu v3.0)"><code class="xref py py-class docutils literal"><span class="pre">kombu.Consumer</span></code></a> object used to consume task messages.</p>
<p>Your consumer bootstep must require the <cite>Tasks</cite> bootstep to use this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'celery.worker.consumer:Tasks'</span><span class="p">,)</span>
</pre></div>
</div>
</dd></dl>
<span class="target" id="extending-consumer-strategies"></span><dl class="attribute">
<dt id="strategies"><a name="//apple_ref/cpp/Attribute/strategies"></a>
<code class="descname">strategies</code><a class="headerlink" href="#strategies" title="Permalink to this definition">¶</a></dt>
<dd><p>Every registered task type has an entry in this mapping,
where the value is used to execute an incoming message of this task type
(the task execution strategy).  This mapping is generated by the Tasks
bootstep when the consumer starts:</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">strategies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">start_strategy</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">consumer</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">__trace__</span> <span class="o">=</span> <span class="n">celery</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">build_tracer</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">hostname</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Your consumer bootstep must require the <cite>Tasks</cite> bootstep to use this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'celery.worker.consumer:Tasks'</span><span class="p">,)</span>
</pre></div>
</div>
</dd></dl>
<span class="target" id="extending-consumer-task-buckets"></span><dl class="attribute">
<dt id="task_buckets"><a name="//apple_ref/cpp/Attribute/task_buckets"></a>
<code class="descname">task_buckets</code><a class="headerlink" href="#task_buckets" title="Permalink to this definition">¶</a></dt>
<dd><p>A <a class="reference external" href="http://docs.python.org/dev/library/collections.html#collections.defaultdict" title="(in Python v3.6)"><code class="xref py py-class docutils literal"><span class="pre">defaultdict</span></code></a> used to lookup the rate limit for
a task by type.
Entries in this dict may be None (for no limit) or a
<a class="reference external" href="http://kombu.readthedocs.org/en/latest/reference/kombu.utils.limits.html#kombu.utils.limits.TokenBucket" title="(in Kombu v3.0)"><code class="xref py py-class docutils literal"><span class="pre">TokenBucket</span></code></a> instance implementing
<code class="docutils literal"><span class="pre">consume(tokens)</span></code> and <code class="docutils literal"><span class="pre">expected_time(tokens)</span></code>.</p>
<p>TokenBucket implements the <a class="reference external" href="http://en.wikipedia.org/wiki/Token_bucket">token bucket algorithm</a>, but any algorithm
may be used as long as it conforms to the same interface and defines the
two methods above.</p>
</dd></dl>
<span class="target" id="extending-consumer-qos"></span><dl class="attribute">
<dt id="qos"><a name="//apple_ref/cpp/Attribute/qos"></a>
<code class="descname">qos</code><a class="headerlink" href="#qos" title="Permalink to this definition">¶</a></dt>
<dd><p>The <code class="xref py py-class docutils literal"><span class="pre">QoS</span></code> object can be used to change the
task channels current prefetch_count value, e.g:</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="c1"># increment at next cycle</span>
<span class="n">consumer</span><span class="o">.</span><span class="n">qos</span><span class="o">.</span><span class="n">increment_eventually</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># decrement at next cycle</span>
<span class="n">consumer</span><span class="o">.</span><span class="n">qos</span><span class="o">.</span><span class="n">decrement_eventually</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">consumer</span><span class="o">.</span><span class="n">qos</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>
</div>
<div class="section" id="methods">
<h3><a class="toc-backref" href="#id11">Methods</a><a class="headerlink" href="#methods" title="Permalink to this headline">¶</a></h3>
<dl class="method">
<dt id="consumer.reset_rate_limits"><a name="//apple_ref/cpp/Method/consumer.reset_rate_limits"></a>
<code class="descclassname">consumer.</code><code class="descname">reset_rate_limits</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#consumer.reset_rate_limits" title="Permalink to this definition">¶</a></dt>
<dd><p>Updates the <code class="docutils literal"><span class="pre">task_buckets</span></code> mapping for all registered task types.</p>
</dd></dl>
<dl class="method">
<dt id="consumer.bucket_for_task"><a name="//apple_ref/cpp/Method/consumer.bucket_for_task"></a>
<code class="descclassname">consumer.</code><code class="descname">bucket_for_task</code><span class="sig-paren">(</span><em>type</em>, <em>Bucket=TokenBucket</em><span class="sig-paren">)</span><a class="headerlink" href="#consumer.bucket_for_task" title="Permalink to this definition">¶</a></dt>
<dd><p>Creates rate limit bucket for a task using its <code class="docutils literal"><span class="pre">task.rate_limit</span></code>
attribute.</p>
</dd></dl>
<dl class="method">
<dt>
<code class="descname">consumer.add_task_queue(name, exchange=None, exchange_type=None,</code></dt>
<dt>
<code class="descname">routing_key=None, **options):</code></dt>
<dd><p>Adds new queue to consume from.  This will persist on connection restart.</p>
</dd></dl>
<dl class="method">
<dt id="consumer.cancel_task_queue"><a name="//apple_ref/cpp/Method/consumer.cancel_task_queue"></a>
<code class="descclassname">consumer.</code><code class="descname">cancel_task_queue</code><span class="sig-paren">(</span><em>name</em><span class="sig-paren">)</span><a class="headerlink" href="#consumer.cancel_task_queue" title="Permalink to this definition">¶</a></dt>
<dd><p>Stop consuming from queue by name.  This will persist on connection
restart.</p>
</dd></dl>
<dl class="method">
<dt id="apply_eta_task"><a name="//apple_ref/cpp/Method/apply_eta_task"></a>
<code class="descname">apply_eta_task</code><span class="sig-paren">(</span><em>request</em><span class="sig-paren">)</span><a class="headerlink" href="#apply_eta_task" title="Permalink to this definition">¶</a></dt>
<dd><p>Schedule eta task to execute based on the <code class="docutils literal"><span class="pre">request.eta</span></code> attribute.
(<a class="reference internal" href="../reference/celery.worker.job.html#celery.worker.job.Request" title="celery.worker.job.Request"><code class="xref py py-class docutils literal"><span class="pre">Request</span></code></a>)</p>
</dd></dl>
</div>
</div>
<div class="section" id="installing-bootsteps">
<span id="extending-bootsteps"></span><h2><a class="toc-backref" href="#id12">Installing Bootsteps</a><a class="headerlink" href="#installing-bootsteps" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">app.steps['worker']</span></code> and <code class="docutils literal"><span class="pre">app.steps['consumer']</span></code> can be modified
to add new bootsteps:</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">'worker'</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyWorkerStep</span><span class="p">)</span>  <span class="c1"># &lt; add class, do not instantiate</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">'consumer'</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyConsumerStep</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">'consumer'</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">StepA</span><span class="p">,</span> <span class="n">StepB</span><span class="p">])</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">'consumer'</span><span class="p">]</span>
<span class="go">{step:proj.StepB{()}, step:proj.MyConsumerStep{()}, step:proj.StepA{()}</span>
</pre></div>
</div>
<p>The order of steps is not important here as the order is decided by the
resulting dependency graph (<code class="docutils literal"><span class="pre">Step.requires</span></code>).</p>
<p>To illustrate how you can install bootsteps and how they work, this is an example step that
prints some useless debugging information.
It can be added both as a worker and consumer bootstep:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">bootsteps</span>

<span class="k">class</span> <span class="nc">InfoStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">Step</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># here we can prepare the Worker/Consumer object</span>
        <span class="c1"># in any way we want, set attribute defaults and so on.</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'{0!r} is in init'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="c1"># our step is started together with all other Worker/Consumer</span>
        <span class="c1"># bootsteps.</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'{0!r} is starting'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="c1"># the Consumer calls stop every time the consumer is restarted</span>
        <span class="c1"># (i.e. connection is lost) and also at shutdown.  The Worker</span>
        <span class="c1"># will call stop at shutdown only.</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'{0!r} is stopping'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="c1"># shutdown is called by the Consumer at shutdown, it's not</span>
        <span class="c1"># called by Worker.</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'{0!r} is shutting down'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s1">'amqp://'</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">'worker'</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">InfoStep</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">'consumer'</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">InfoStep</span><span class="p">)</span>
</pre></div>
</div>
<p>Starting the worker with this step installed will give us the following
logs:</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">Worker</span><span class="p">:</span> <span class="n">w</span><span class="nd">@example</span><span class="o">.</span><span class="n">com</span> <span class="p">(</span><span class="n">initializing</span><span class="p">)</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">init</span>
<span class="o">&lt;</span><span class="n">Consumer</span><span class="p">:</span> <span class="n">w</span><span class="nd">@example</span><span class="o">.</span><span class="n">com</span> <span class="p">(</span><span class="n">initializing</span><span class="p">)</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">init</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">544</span><span class="p">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span>
    <span class="o">&lt;</span><span class="n">Worker</span><span class="p">:</span> <span class="n">w</span><span class="nd">@example</span><span class="o">.</span><span class="n">com</span> <span class="p">(</span><span class="n">running</span><span class="p">)</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="n">starting</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">577</span><span class="p">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span>
    <span class="o">&lt;</span><span class="n">Consumer</span><span class="p">:</span> <span class="n">w</span><span class="nd">@example</span><span class="o">.</span><span class="n">com</span> <span class="p">(</span><span class="n">running</span><span class="p">)</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="n">starting</span>
<span class="o">&lt;</span><span class="n">Consumer</span><span class="p">:</span> <span class="n">w</span><span class="nd">@example</span><span class="o">.</span><span class="n">com</span> <span class="p">(</span><span class="n">closing</span><span class="p">)</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="n">stopping</span>
<span class="o">&lt;</span><span class="n">Worker</span><span class="p">:</span> <span class="n">w</span><span class="nd">@example</span><span class="o">.</span><span class="n">com</span> <span class="p">(</span><span class="n">closing</span><span class="p">)</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="n">stopping</span>
<span class="o">&lt;</span><span class="n">Consumer</span><span class="p">:</span> <span class="n">w</span><span class="nd">@example</span><span class="o">.</span><span class="n">com</span> <span class="p">(</span><span class="n">terminating</span><span class="p">)</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="n">shutting</span> <span class="n">down</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">print</span></code> statements will be redirected to the logging subsystem after
the worker has been initialized, so the “is starting” lines are timestamped.
You may notice that this does no longer happen at shutdown, this is because
the <code class="docutils literal"><span class="pre">stop</span></code> and <code class="docutils literal"><span class="pre">shutdown</span></code> methods are called inside a <em>signal handler</em>,
and it’s not safe to use logging inside such a handler.
Logging with the Python logging module is not <a class="reference internal" href="../glossary.html#term-reentrant"><span class="xref std std-term">reentrant</span></a>,
which means that you cannot interrupt the function and
call it again later.  It’s important that the <code class="docutils literal"><span class="pre">stop</span></code> and <code class="docutils literal"><span class="pre">shutdown</span></code> methods
you write is also <a class="reference internal" href="../glossary.html#term-reentrant"><span class="xref std std-term">reentrant</span></a>.</p>
<p>Starting the worker with <code class="docutils literal"><span class="pre">--loglevel=debug</span></code> will show us more
information about the boot process:</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">509</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Worker</span><span class="p">:</span> <span class="n">Preparing</span> <span class="n">bootsteps</span><span class="o">.</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">511</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Worker</span><span class="p">:</span> <span class="n">Building</span> <span class="n">graph</span><span class="o">...</span>
<span class="o">&lt;</span><span class="n">celery</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">Worker</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x101ad8410</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">init</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">511</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Worker</span><span class="p">:</span> <span class="n">New</span> <span class="n">boot</span> <span class="n">order</span><span class="p">:</span>
    <span class="p">{</span><span class="n">Hub</span><span class="p">,</span> <span class="n">Queues</span> <span class="p">(</span><span class="n">intra</span><span class="p">),</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">Autoreloader</span><span class="p">,</span> <span class="n">Timer</span><span class="p">,</span> <span class="n">StateDB</span><span class="p">,</span>
     <span class="n">Autoscaler</span><span class="p">,</span> <span class="n">InfoStep</span><span class="p">,</span> <span class="n">Beat</span><span class="p">,</span> <span class="n">Consumer</span><span class="p">}</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">514</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Preparing</span> <span class="n">bootsteps</span><span class="o">.</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">514</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Building</span> <span class="n">graph</span><span class="o">...</span>
<span class="o">&lt;</span><span class="n">celery</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">Consumer</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x101c2d8d0</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">init</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">515</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">New</span> <span class="n">boot</span> <span class="n">order</span><span class="p">:</span>
    <span class="p">{</span><span class="n">Connection</span><span class="p">,</span> <span class="n">Mingle</span><span class="p">,</span> <span class="n">Events</span><span class="p">,</span> <span class="n">Gossip</span><span class="p">,</span> <span class="n">InfoStep</span><span class="p">,</span> <span class="n">Agent</span><span class="p">,</span>
     <span class="n">Heart</span><span class="p">,</span> <span class="n">Control</span><span class="p">,</span> <span class="n">Tasks</span><span class="p">,</span> <span class="n">event</span> <span class="n">loop</span><span class="p">}</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">522</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Worker</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Hub</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">522</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">522</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Worker</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Pool</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">542</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">543</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Worker</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">InfoStep</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">544</span><span class="p">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span>
    <span class="o">&lt;</span><span class="n">celery</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">Worker</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x101ad8410</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="n">starting</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">544</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">544</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Worker</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Consumer</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">544</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Connection</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">559</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Connected</span> <span class="n">to</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">guest</span><span class="nd">@127</span><span class="o">.</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5672</span><span class="o">//</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">560</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">560</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Mingle</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">560</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">mingle</span><span class="p">:</span> <span class="n">searching</span> <span class="k">for</span> <span class="n">neighbors</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">570</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">mingle</span><span class="p">:</span> <span class="n">no</span> <span class="n">one</span> <span class="n">here</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">570</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">571</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Events</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">572</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">572</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Gossip</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">577</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">577</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">InfoStep</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">577</span><span class="p">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span>
    <span class="o">&lt;</span><span class="n">celery</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">Consumer</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x101c2d8d0</span><span class="o">&gt;</span> <span class="ow">is</span> <span class="n">starting</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">578</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">578</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Heart</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">579</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">579</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Control</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">583</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">583</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Tasks</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">606</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">basic</span><span class="o">.</span><span class="n">qos</span><span class="p">:</span> <span class="n">prefetch_count</span><span class="o">-&gt;</span><span class="mi">80</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">606</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">606</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">event</span> <span class="n">loop</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">608</span><span class="p">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">celery</span><span class="nd">@example</span><span class="o">.</span><span class="n">com</span> <span class="n">ready</span><span class="o">.</span>
</pre></div>
</div>
</div>
<div class="section" id="command-line-programs">
<span id="extending-programs"></span><h2><a class="toc-backref" href="#id13">Command-line programs</a><a class="headerlink" href="#command-line-programs" title="Permalink to this headline">¶</a></h2>
<div class="section" id="adding-new-command-line-options">
<span id="extending-commandoptions"></span><h3><a class="toc-backref" href="#id14">Adding new command-line options</a><a class="headerlink" href="#adding-new-command-line-options" title="Permalink to this headline">¶</a></h3>
<div class="section" id="command-specific-options">
<span id="extending-command-options"></span><h4>Command-specific options<a class="headerlink" href="#command-specific-options" title="Permalink to this headline">¶</a></h4>
<p>You can add additional command-line options to the <code class="docutils literal"><span class="pre">worker</span></code>, <code class="docutils literal"><span class="pre">beat</span></code> and
<code class="docutils literal"><span class="pre">events</span></code> commands by modifying the <a class="reference internal" href="../reference/celery.html#celery.Celery.user_options" title="celery.Celery.user_options"><code class="xref py py-attr docutils literal"><span class="pre">user_options</span></code></a> attribute of the
application instance.</p>
<p>Celery commands uses the <a class="reference external" href="http://docs.python.org/dev/library/optparse.html#module-optparse" title="(in Python v3.6)"><code class="xref py py-mod docutils literal"><span class="pre">optparse</span></code></a> module to parse command-line
arguments, and so you have to use <a class="reference external" href="http://docs.python.org/dev/library/optparse.html#module-optparse" title="(in Python v3.6)"><code class="xref py py-mod docutils literal"><span class="pre">optparse</span></code></a> specific option instances created
using <code class="xref py py-func docutils literal"><span class="pre">optparse.make_option()</span></code>.  Please see the <a class="reference external" href="http://docs.python.org/dev/library/optparse.html#module-optparse" title="(in Python v3.6)"><code class="xref py py-mod docutils literal"><span class="pre">optparse</span></code></a>
documentation to read about the fields supported.</p>
<p>Example adding a custom option to the <strong class="program">celery worker</strong> command:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span> <span class="nn">celery.bin</span> <span class="kn">import</span> <span class="n">Option</span>  <span class="c1"># &lt;-- alias to optparse.make_option</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s1">'amqp://'</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">user_options</span><span class="p">[</span><span class="s1">'worker'</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="n">Option</span><span class="p">(</span><span class="s1">'--enable-my-option'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
           <span class="n">help</span><span class="o">=</span><span class="s1">'Enable custom option.'</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>All bootsteps will now receive this argument as a keyword argument to
<code class="docutils literal"><span class="pre">Bootstep.__init__</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">bootsteps</span>

<span class="k">class</span> <span class="nc">MyBootstep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">Step</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">enable_my_option</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">enable_my_option</span><span class="p">:</span>
            <span class="n">party</span><span class="p">()</span>

<span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">'worker'</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyBootstep</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="preload-options">
<span id="extending-preload-options"></span><h4>Preload options<a class="headerlink" href="#preload-options" title="Permalink to this headline">¶</a></h4>
<p>The <strong class="program">celery</strong> umbrella command supports the concept of ‘preload
options’, which are special options passed to all subcommands and parsed
outside of the main parsing step.</p>
<p>The list of default preload options can be found in the API reference:
<a class="reference internal" href="../reference/celery.bin.base.html#module-celery.bin.base" title="celery.bin.base"><code class="xref py py-mod docutils literal"><span class="pre">celery.bin.base</span></code></a>.</p>
<p>You can add new preload options too, e.g. to specify a configuration template:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">celery.bin</span> <span class="kn">import</span> <span class="n">Option</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">user_options</span><span class="p">[</span><span class="s1">'preload'</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="n">Option</span><span class="p">(</span><span class="s1">'-Z'</span><span class="p">,</span> <span class="s1">'--template'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">'default'</span><span class="p">,</span>
           <span class="n">help</span><span class="o">=</span><span class="s1">'Configuration template to use.'</span><span class="p">),</span>
<span class="p">)</span>

<span class="nd">@signals.user_preload_options.connect</span>
<span class="k">def</span> <span class="nf">on_preload_parsed</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">use_template</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">'template'</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="adding-new-celery-sub-commands">
<span id="extending-subcommands"></span><h3><a class="toc-backref" href="#id15">Adding new <strong class="program">celery</strong> sub-commands</a><a class="headerlink" href="#adding-new-celery-sub-commands" title="Permalink to this headline">¶</a></h3>
<p>New commands can be added to the <strong class="program">celery</strong> umbrella command by using
<a class="reference external" href="http://reinout.vanrees.org/weblog/2010/01/06/zest-releaser-entry-points.html">setuptools entry-points</a>.</p>
<p>Entry-points is special metadata that can be added to your packages <code class="docutils literal"><span class="pre">setup.py</span></code> program,
and then after installation, read from the system using the <code class="xref py py-mod docutils literal"><span class="pre">pkg_resources</span></code> module.</p>
<p>Celery recognizes <code class="docutils literal"><span class="pre">celery.commands</span></code> entry-points to install additional
subcommands, where the value of the entry-point must point to a valid subclass
of <a class="reference internal" href="../reference/celery.bin.base.html#celery.bin.base.Command" title="celery.bin.base.Command"><code class="xref py py-class docutils literal"><span class="pre">celery.bin.base.Command</span></code></a>.  There is limited documentation,
unfortunately, but you can find inspiration from the various commands in the
<code class="xref py py-mod docutils literal"><span class="pre">celery.bin</span></code> package.</p>
<p>This is how the <a class="reference external" href="http://pypi.python.org/pypi/flower">Flower</a> monitoring extension adds the <strong class="program">celery flower</strong> command,
by adding an entry-point in <code class="file docutils literal"><span class="pre">setup.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">'flower'</span><span class="p">,</span>
    <span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">'celery.commands'</span><span class="p">:</span> <span class="p">[</span>
           <span class="s1">'flower = flower.command.FlowerCommand'</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The command definition is in two parts separated by the equal sign, where the
first part is the name of the subcommand (flower), then the fully qualified
module path to the class that implements the command
(<code class="docutils literal"><span class="pre">flower.command.FlowerCommand</span></code>).</p>
<p>In the module <code class="file docutils literal"><span class="pre">flower/command.py</span></code>, the command class is defined
something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery.bin.base</span> <span class="kn">import</span> <span class="n">Command</span><span class="p">,</span> <span class="n">Option</span>


<span class="k">class</span> <span class="nc">FlowerCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">Option</span><span class="p">(</span><span class="s1">'--port'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8888</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">'int'</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">'Webserver port'</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">Option</span><span class="p">(</span><span class="s1">'--debug'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Running our command'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="worker-api">
<h2><a class="toc-backref" href="#id16">Worker API</a><a class="headerlink" href="#worker-api" title="Permalink to this headline">¶</a></h2>
<div class="section" id="hub-the-workers-async-event-loop">
<h3><a class="toc-backref" href="#id17"></a><a class="reference external" href="http://kombu.readthedocs.org/en/latest/reference/kombu.async.html#kombu.async.Hub" title="(in Kombu v3.0)"><code class="xref py py-class docutils literal"><span class="pre">Hub</span></code></a> - The workers async event loop.<a class="headerlink" href="#hub-the-workers-async-event-loop" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name"></col>
<col class="field-body"></col>
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">supported transports:</th></tr>
<tr class="field-odd field"><td> </td><td class="field-body">amqp, redis</td>
</tr>
</tbody>
</table>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.0.</span></p>
</div>
<p>The worker uses asynchronous I/O when the amqp or redis broker transports are
used.  The eventual goal is for all transports to use the eventloop, but that
will take some time so other transports still use a threading-based solution.</p>
<dl class="method">
<dt id="hub.add"><a name="//apple_ref/cpp/Method/hub.add"></a>
<code class="descclassname">hub.</code><code class="descname">add</code><span class="sig-paren">(</span><em>fd</em>, <em>callback</em>, <em>flags</em><span class="sig-paren">)</span><a class="headerlink" href="#hub.add" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
<dl class="method">
<dt id="hub.add_reader"><a name="//apple_ref/cpp/Method/hub.add_reader"></a>
<code class="descclassname">hub.</code><code class="descname">add_reader</code><span class="sig-paren">(</span><em>fd</em>, <em>callback</em>, <em>*args</em><span class="sig-paren">)</span><a class="headerlink" href="#hub.add_reader" title="Permalink to this definition">¶</a></dt>
<dd><p>Add callback to be called when <code class="docutils literal"><span class="pre">fd</span></code> is readable.</p>
<p>The callback will stay registered until explictly removed using
<a class="reference internal" href="#hub.remove" title="hub.remove"><code class="xref py py-meth docutils literal"><span class="pre">hub.remove(fd)</span></code></a>, or the fd is automatically discarded
because it’s no longer valid.</p>
<p>Note that only one callback can be registered for any given fd at a time,
so calling <code class="docutils literal"><span class="pre">add</span></code> a second time will remove any callback that
was previously registered for that fd.</p>
<p>A file descriptor is any file-like object that supports the <code class="docutils literal"><span class="pre">fileno</span></code>
method, or it can be the file descriptor number (int).</p>
</dd></dl>
<dl class="method">
<dt id="hub.add_writer"><a name="//apple_ref/cpp/Method/hub.add_writer"></a>
<code class="descclassname">hub.</code><code class="descname">add_writer</code><span class="sig-paren">(</span><em>fd</em>, <em>callback</em>, <em>*args</em><span class="sig-paren">)</span><a class="headerlink" href="#hub.add_writer" title="Permalink to this definition">¶</a></dt>
<dd><p>Add callback to be called when <code class="docutils literal"><span class="pre">fd</span></code> is writable.
See also notes for <a class="reference internal" href="#hub.add_reader" title="hub.add_reader"><code class="xref py py-meth docutils literal"><span class="pre">hub.add_reader()</span></code></a> above.</p>
</dd></dl>
<dl class="method">
<dt id="hub.remove"><a name="//apple_ref/cpp/Method/hub.remove"></a>
<code class="descclassname">hub.</code><code class="descname">remove</code><span class="sig-paren">(</span><em>fd</em><span class="sig-paren">)</span><a class="headerlink" href="#hub.remove" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove all callbacks for <code class="docutils literal"><span class="pre">fd</span></code> from the loop.</p>
</dd></dl>
</div>
<div class="section" id="timer-scheduling-events">
<h3><a class="toc-backref" href="#id18">Timer - Scheduling events</a><a class="headerlink" href="#timer-scheduling-events" title="Permalink to this headline">¶</a></h3>
<dl class="method">
<dt>
<code class="descname">timer.call_after(secs, callback, args=(), kwargs=(),</code></dt>
<dt>
<code class="descname">priority=0)</code></dt>
<dd></dd></dl>
<dl class="method">
<dt>
<code class="descname">timer.call_repeatedly(secs, callback, args=(), kwargs=(),</code></dt>
<dt>
<code class="descname">priority=0)</code></dt>
<dd></dd></dl>
<dl class="method">
<dt>
<code class="descname">timer.call_at(eta, callback, args=(), kwargs=(),</code></dt>
<dt>
<code class="descname">priority=0)</code></dt>
<dd></dd></dl>
</div>
</div>
</div>
</div>
</div>
</div>

<div class="clearer"></div>
</div>

<div class="footer" role="contentinfo">
        © <a href="../copyright.html">Copyright</a> 2009-2015, Ask Solem &amp; Contributors.
    </div>
</body>
</html>